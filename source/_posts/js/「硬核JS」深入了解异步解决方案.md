---
title: ã€Œç¡¬æ ¸JSã€æ·±å…¥äº†è§£å¼‚æ­¥è§£å†³æ–¹æ¡ˆ
tags: [JavaScript]
categories: ç¡¬æ ¸JSç³»åˆ—
index_img: https://gitee.com/IsboyJC/PictureBed/raw/master/other/js.jpg
date: 2020-02-14 14:00:00
---

<!-- more -->

## å‰è¨€

Javascript è¯­è¨€çš„æ‰§è¡Œç¯å¢ƒæ˜¯`å•çº¿ç¨‹`(single threadï¼ŒæŒ‡ä¸€æ¬¡åªèƒ½å®Œæˆä¸€ä»¶ä»»åŠ¡ï¼Œå¦‚æœæœ‰å¤šä¸ªä»»åŠ¡ï¼Œå°±å¿…é¡»æ’é˜Ÿï¼Œå‰é¢ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå†æ‰§è¡Œåé¢ä¸€ä¸ªä»»åŠ¡ï¼Œä»¥æ­¤ç±»æ¨)

è¿™ç§æ¨¡å¼çš„å¥½å¤„æ˜¯å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œæ‰§è¡Œç¯å¢ƒç›¸å¯¹å•çº¯ï¼Œåå¤„æ˜¯åªè¦æœ‰ä¸€ä¸ªä»»åŠ¡è€—æ—¶å¾ˆé•¿ï¼Œåé¢çš„ä»»åŠ¡éƒ½å¿…é¡»æ’é˜Ÿç­‰ç€ï¼Œä¼šæ‹–å»¶æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œï¼Œå¸¸è§çš„æµè§ˆå™¨æ— å“åº”(å‡æ­»)ï¼Œå¾€å¾€å°±æ˜¯å› ä¸ºæŸä¸€æ®µ Javascript ä»£ç é•¿æ—¶é—´è¿è¡Œ(æ¯”å¦‚æ­»å¾ªç¯)ï¼Œå¯¼è‡´æ•´ä¸ªé¡µé¢å¡åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œå…¶ä»–ä»»åŠ¡æ— æ³•æ‰§è¡Œ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavascript å°†ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼åˆ†æˆä¸¤ç§ï¼šåŒæ­¥(Synchronous)å’Œå¼‚æ­¥(Asynchronous)

`åŒæ­¥æ¨¡å¼` å°±æ˜¯åä¸€ä¸ªä»»åŠ¡ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡ç»“æŸï¼Œç„¶åå†æ‰§è¡Œï¼Œç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸ä»»åŠ¡çš„æ’åˆ—é¡ºåºæ˜¯ä¸€è‡´çš„ã€åŒæ­¥çš„

`å¼‚æ­¥æ¨¡å¼`åˆ™å®Œå…¨ä¸åŒï¼Œæ¯ä¸€ä¸ªä»»åŠ¡æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå›è°ƒå‡½æ•°(callback)ï¼Œå‰ä¸€ä¸ªä»»åŠ¡ç»“æŸåï¼Œä¸æ˜¯æ‰§è¡Œåä¸€ä¸ªä»»åŠ¡ï¼Œè€Œæ˜¯æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œåä¸€ä¸ªä»»åŠ¡åˆ™æ˜¯ä¸ç­‰å‰ä¸€ä¸ªä»»åŠ¡ç»“æŸå°±æ‰§è¡Œï¼Œæ‰€ä»¥ç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸ä»»åŠ¡çš„æ’åˆ—é¡ºåºæ˜¯ä¸ä¸€è‡´çš„ã€å¼‚æ­¥çš„ï¼Œåœ¨æµè§ˆå™¨ç«¯ï¼Œè€—æ—¶å¾ˆé•¿çš„æ“ä½œéƒ½åº”è¯¥å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…æµè§ˆå™¨å¤±å»å“åº”ï¼Œæœ€å¥½çš„ä¾‹å­å°±æ˜¯ Ajax æ“ä½œã€‚åœ¨æœåŠ¡å™¨ç«¯ï¼Œ`å¼‚æ­¥æ¨¡å¼`ç”šè‡³æ˜¯å”¯ä¸€çš„æ¨¡å¼ï¼Œå› ä¸ºæ‰§è¡Œç¯å¢ƒæ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœå…è®¸åŒæ­¥æ‰§è¡Œæ‰€æœ‰ http è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™

å‰é¢éƒ½æ˜¯äº›æ— ç”¨çš„è¯ï¼Œå› ä¸ºå¤§å®¶éƒ½å¯¹æ­¤å¾ˆæ¸…æ¥šï¼Œé‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼Œä½ äº†è§£å‡ ç§å¼‚æ­¥è§£å†³æ–¹æ¡ˆï¼Ÿ

æœ¬æ–‡ä¼šç”±æµ…å…¥æ·±çš„å™è¿°ä¸‹é¢å‡ ç§å·²çŸ¥çš„å¼‚æ­¥è§£å†³æ–¹æ¡ˆï¼Œä»¥åŠå®ƒä»¬çš„åŒºåˆ«

- å›è°ƒå‡½æ•°(callback)
- äº‹ä»¶ç›‘å¬(å‘å¸ƒ/è®¢é˜…)è§£æ
- Promise è§£æåŠä» 0 ï½ 1 çš„æºç ä½“éªŒ
- Generator å…¨é¢è§£æ
- Async/Await è§£æ

èµ¶ä¸Šæ˜¥èŠ‚ä¸å‡ºé—¨ä¸ºå›½å®¶åšè´¡çŒ®ï¼Œå†™äº†è¿™ç¯‡å¸–å­ï¼Œæœ¬æ–‡æœ‰ç‚¹é•¿ï¼Œå› ä¸ºæœ¬æ¥è¦å†™å››ç¯‡æ–‡ç« åˆ†åˆ«å™è¿°ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿˜æ˜¯åœ¨ä¸€å—çœ‹æ¯”è¾ƒå®¹æ˜“å¯¹æ¯”ç†è§£ï¼Œå¤§æ¦‚æœ‰ä¸¤ä¸‡å­—å·¦å³ï¼Œå¦‚æœä½ è‚¯èŠ± 20 åˆ†é’Ÿçš„æ—¶é—´é˜…è¯»æœ¬æ–‡ï¼Œå®šä¼šæœ‰æ‰€æ”¶è·ï¼Œæˆ‘åœ¨è€å¿ƒå†™ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶å¯ä»¥è€å¿ƒçœ‹å®Œï¼ŒåŸºç¡€ä¸å¤ªå¥½çš„åŒå­¦å¯ä»¥åˆ†å—çœ‹ï¼Œå·²è¯¦ç»†æ³¨æ˜å„çº§æ ‡é¢˜ï¼Œå¸Œæœ›é€šè¿‡æœ¬æ–‡å¯ä»¥è®©å¤§å®¶å¯¹å¤§ JS å¼‚æ­¥ç¼–ç¨‹åŠ æ·±äº†è§£

å“¦å¯¹äº†ï¼Œå…ˆèµåœ¨çœ‹ï¼Œå…»æˆä¹ æƒ¯ï¼Œæ¯•ç«Ÿç å­—ä¸æ˜“ï¼Œå¤§å®¶çš„æ¯ä¸€ä¸ªèµå’Œè¯„è®ºéƒ½å°†ä¸ºæˆ‘ç ä¸‹ä¸€ç¯‡æ–‡ç« æ·»ä¸€äº›åŠ¨åŠ›ï¼Œå¤šè°¢ ğŸ˜

## å›è°ƒå‡½æ•°(callback)

### ç®€è¿°å›è°ƒå‡½æ•°

å›è°ƒå‡½æ•°å¤§å®¶éƒ½åº”è¯¥æ¸…æ¥šï¼Œç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªå‡½æ•°è¢«ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°

å›è°ƒå¹¶ä¸ä¸€å®šå°±æ˜¯å¼‚æ­¥ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œåªä¸è¿‡å›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬ç”¨ä¾‹å­æ¥ç®€å•è¯´æ˜ä¸‹

```js
function fn1(callback) {
  console.log("1")
  callback && callback()
}

function fn2() {
  console.log("2")
}

fn1(fn2)
```

å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œå‡½æ•° fn1 å‚æ•°ä¸ºä¸€ä¸ªå›è°ƒï¼Œè°ƒç”¨ fn1 æ—¶ä¼ è¿›å…¥äº†å‡½æ•° fn2ï¼Œé‚£ä¹ˆåœ¨å‡½æ•° fn1 æ‰§è¡Œåˆ° callback å‡½æ•°è°ƒç”¨æ—¶ä¼šè°ƒç”¨ fn2 æ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å›è°ƒå‡½æ•°ï¼Œä¸è¿‡æ˜¯åŒæ­¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ç‚¹æ¥è§£å†³å¼‚æ­¥ï¼Œå¦‚ä¸‹

```js
fn1(callback){
  setTimeout(() => {
    callback && callback()
  }, 1000)
}

fn1(()=>{
  console.log("1")
})
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ setTimeout åœ¨å‡½æ•° fn1 ä¸­æ¨¡æ‹Ÿäº†ä¸€ä¸ªè€—æ—¶ 1s çš„ä»»åŠ¡ï¼Œè€—æ—¶ä»»åŠ¡ç»“æŸä¼šæŠ›å‡ºä¸€ä¸ªå›è°ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è°ƒç”¨æ—¶å°±å¯ä»¥åšåˆ°åœ¨å‡½æ•° fn1 çš„è€—æ—¶ä»»åŠ¡ç»“æŸåæ‰§è¡Œå›è°ƒå‡½æ•°äº†

é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬æŠŠåŒæ­¥æ“ä½œå˜æˆäº†å¼‚æ­¥æ“ä½œï¼Œfn1 ä¸ä¼šå µå¡ç¨‹åºè¿è¡Œï¼Œç›¸å½“äºå…ˆæ‰§è¡Œç¨‹åºçš„ä¸»è¦é€»è¾‘ï¼Œå°†è€—æ—¶çš„æ“ä½œæ¨è¿Ÿæ‰§è¡Œ

### å›è°ƒå‡½æ•°ä¼˜/ç¼º

**ä¼˜ç‚¹**

ä¸€å¥è¯ï¼Œå›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥ç¼–ç¨‹æœ€åŸºæœ¬çš„æ–¹æ³•ï¼Œå…¶ä¼˜ç‚¹æ˜¯ç®€å•ã€å®¹æ˜“ç†è§£å’Œéƒ¨ç½²

**ç¼ºç‚¹**

å›è°ƒå‡½æ•°æœ€å¤§çš„ç¼ºç‚¹æ˜¯ä¸åˆ©äºä»£ç çš„é˜…è¯»å’Œç»´æŠ¤ï¼Œå„ä¸ªéƒ¨åˆ†ä¹‹é—´é«˜åº¦è€¦åˆ(Coupling)

```js
fun1(() => {
  fun2(() => {
    fun3(() => {
      fun4(() => {
        fun5(() => {
          fun6()
        })
      })
    })
  })
})
```

ä¸Šé¢è¿™ç§ä»£ç åœ¨ä¹‹å‰ä½¿ç”¨ AJAX è¯·æ±‚æ—¶å¾ˆå¸¸è§ï¼Œå› ä¸ºä¸šåŠ¡ä¸Šåœ¨ä¸€ä¸ªè¯·æ±‚ç»“æŸåå‘èµ·å¦ä¸€ä¸ªè¯·æ±‚çš„éœ€æ±‚å¤ªå¤šäº†ï¼Œä»£ç ä¸ä¼˜é›…ï¼Œä¸æ˜“é˜…è¯»ç»´æŠ¤ï¼Œé«˜è€¦åˆï¼Œå±‚å±‚åµŒå¥—é€ æˆè¿™ç§**å›è°ƒåœ°ç‹±**

å¼‚æ­¥å›è°ƒä¸­ï¼Œå›è°ƒå‡½æ•°çš„æ‰§è¡Œæ ˆä¸åŸå‡½æ•°åˆ†ç¦»å¼€ï¼Œå¤–éƒ¨æ— æ³•æŠ“ä½å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šå˜å¾—ä¸å¯æ§

è™½ç„¶ç¼ºç‚¹å¤šï¼Œä½†å›è°ƒå‡½æ•°æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿä¸å¯æˆ–ç¼ºï¼Œä½¿ç”¨æ—¶æ³¨æ„å°±å¥½äº†

å›è°ƒå‡½æ•°æ¯”è¾ƒç®€å•å¸¸ç”¨ï¼Œå°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹äº‹ä»¶ç›‘å¬

## äº‹ä»¶ç›‘å¬(å‘å¸ƒè®¢é˜…æ¨¡å¼)

è§£å†³å¼‚æ­¥ï¼Œå¯ä»¥é‡‡ç”¨äº‹ä»¶é©±åŠ¨ï¼Œä»»åŠ¡çš„æ‰§è¡Œä¸å–å†³äºä»£ç çš„é¡ºåºï¼Œè€Œå–å†³äºæŸä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿ

åœ¨é˜®ä¸€å³°è€å¸ˆæ—©æœŸå‘å¸ƒçš„ **Javascript å¼‚æ­¥ç¼–ç¨‹çš„ 4 ç§æ–¹æ³•(å‚è€ƒé“¾æ¥ã€1ã€‘)** ä¸€æ–‡ä¸­ï¼ŒæŠŠäº‹ä»¶ç›‘å¬å’Œå‘å¸ƒè®¢é˜…ä½œä¸ºäº†ä¸åŒçš„ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘ä¸ªäººè§‰å¾—è¿™ä¸¤ç§å®Œå…¨å¯ä»¥å¹¶ä¸ºä¸€ç§ï¼Œéƒ½æ˜¯åˆ©ç”¨äº†å‘å¸ƒè®¢é˜…æ¨¡å¼çš„äº‹ä»¶é©±åŠ¨ï¼Œæ‰€ä»¥å°±æ”¾ä¸€å—è§£é‡Šäº†

### JQuery å®ç°äº‹ä»¶ç›‘å¬

jquery å®ç°æ¯”è¾ƒç®€å•ï¼Œå› ä¸º jq ä¸ºæˆ‘ä»¬å°è£…å¥½äº†æ–¹æ³•ï¼Œä½¿ç”¨å³å¯ï¼Œåªæ˜¯ JQ ä¸å¸¸ç”¨äº†ï¼Œç®€å•äº†è§£ä¸‹

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ jquery ä¸­çš„`on`æ¥ç›‘å¬äº‹ä»¶ï¼Œä½¿ç”¨`trigger`è§¦å‘äº‹ä»¶ï¼Œå¦‚ä¸‹

```js
$("body").on("done", fn2)

function fn1() {
  setTimeout(function () {
    $("body").trigger("done")
  }, 2000)
}

function fn2() {
  console.log("fn2æ‰§è¡Œäº†")
}
fn1()
```

æˆ‘ä»¬ä½¿ç”¨ jq çš„`on`ç›‘å¬äº†ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶`done`ï¼Œä¼ å…¥äº† fn2 å›è°ƒï¼Œè¡¨ç¤ºäº‹ä»¶è§¦å‘åç«‹å³æ‰§è¡Œå‡½æ•° fn2

åœ¨å‡½æ•° fn1 ä¸­ä½¿ç”¨ setTimeout æ¨¡æ‹Ÿäº†è€—æ—¶ä»»åŠ¡ï¼ŒsetTimeout å›è°ƒä¸­ä½¿ç”¨`trigger`è§¦å‘äº†`done`äº‹ä»¶

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`on`æ¥ç»‘å®šå¤šä¸ªäº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶å¯ä»¥æŒ‡å®šå¤šä¸ªå›è°ƒå‡½æ•°

### JavaScript å®ç°äº‹ä»¶ç›‘å¬

åœ¨ JS ä¸­æˆ‘ä»¬è¦è‡ªå·±å®ç°ç±»ä¼¼ JQ çš„`on`å’Œ`trigger`äº†

å®ç°çš„è¿‡ç¨‹ä¸­ç”¨åˆ°äº†ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œæ‰€ä»¥ç®€å•æä¸€ä¸‹

#### ç®€è¿°å‘å¸ƒè®¢é˜…æ¨¡å¼(è§‚å¯Ÿè€…æ¨¡å¼)

å‘å¸ƒè®¢é˜…æ¨¡å¼(publish-subscribe pattern)ï¼Œåˆå«è§‚å¯Ÿè€…æ¨¡å¼(observer pattern)ï¼Œå®šä¹‰äº†å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥

æ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒæŒ«çš„ä¾‹å­

```js
å°æè¾›è¾›è‹¦è‹¦åšäº†ä¸¤å¹´ç¨‹åºçŒ¿ï¼Œæ”’äº†äº›é’±ï¼Œå†…å¿ƒæ¿€åŠ¨ï¼Œè¦å»å”®æ¥¼éƒ¨ä¹°ä¸€ä¸ªå¿ƒä»ªå·²ä¹…çš„æˆ¿å‹

åˆ°å”®æ¥¼éƒ¨é—®äº†ä¸‹ï¼Œå”®æ¥¼éƒ¨è¯´æš‚æ—¶æ²¡æœ‰è¿™ç§æˆ¿å‹çš„æˆ¿æºäº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Œä¸‹æ¬¡å†æ¥å§

ä½†æ˜¯å°æä¸çŸ¥é“è¿™ç§æˆ¿å‹ä»€ä¹ˆæ—¶å€™æœ‰æˆ¿æºï¼Œæ€»ä¸èƒ½æ¯å¤©æ‰“ç”µè¯åˆ°å”®æ¥¼éƒ¨é—®å§ï¼Œå°æå°±æŠŠç”µè¯å’Œæˆ¿å‹ä¿¡æ¯ç•™åˆ°å”®æ¥¼éƒ¨äº†ï¼Œä»€ä¹ˆæ—¶å€™æœ‰è¿™ç§æˆ¿æºäº†ï¼Œå”®æ¥¼éƒ¨ä¼šçŸ­ä¿¡é€šçŸ¥

è¦çŸ¥é“ï¼Œå”®æ¥¼éƒ¨ä¸ä¼šåªé€šçŸ¥å°æä¸€ä¸ªäººï¼Œå”®æ¥¼éƒ¨ä¼šæŠŠé¢„ç•™ä¿¡æ¯æ‰€æœ‰æˆ¿å‹ä¿¡æ¯ä¸€è‡´çš„äººéƒ½é€šçŸ¥ä¸€é

åœ¨è¿™ä¸ªæ¯”è¾ƒæŒ«çš„ä¾‹å­ä¸­ï¼Œå°æåŒ…æ‹¬æ¯ä¸ªä¹°æˆ¿çš„äººéƒ½æ˜¯è®¢é˜…è€…ï¼Œè€Œå”®æ¥¼éƒ¨å°±æ˜¯å‘å¸ƒè€…
```

å…¶å®æˆ‘ä»¬éƒ½ç”¨è¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ DOM èŠ‚ç‚¹ä¸Šç»‘å®šä¸€ä¸ªäº‹ä»¶å‡½æ•°ï¼Œå°±å·²ç»ä½¿ç”¨äº†

```js
document.body.addEventListener("click", function () {
  console.log(1)
})
```

ä½†æ˜¯è¿™åªæ˜¯å¯¹å‘å¸ƒè®¢é˜…æ¨¡å¼æœ€ç®€å•çš„ä½¿ç”¨ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹æˆ‘ä»¬ç»å¸¸ä¼šå®ç°ä¸€äº›è‡ªå®šä¹‰äº‹ä»¶æ¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚

æ¯”å¦‚æˆ‘ä»¬ä¸‹é¢è¦é˜²ç…§ JQ é‚£ç§æ¥å†™ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨ï¼Œéœ€è¦ç›‘å¬ä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨è¯¥äº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œå…¶ç›‘å¬å›è°ƒ

#### å‘å¸ƒè®¢é˜…æ¨¡å¼å®ç°äº‹ä»¶ç›‘å¬å™¨

å‘å¸ƒè®¢é˜…æ¨¡å¼æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨`class`æ¥ç®€å•å®ç°ä¸‹

```js
class Emitter {
  constructor() {
    // _listeneræ•°ç»„ï¼Œkeyä¸ºè‡ªå®šä¹‰äº‹ä»¶åï¼Œvalueä¸ºæ‰§è¡Œå›è°ƒæ•°ç»„-å› ä¸ºå¯èƒ½æœ‰å¤šä¸ª
    this._listener = []
  }

  // è®¢é˜… ç›‘å¬äº‹ä»¶
  on(type, fn) {
    // åˆ¤æ–­_listeneræ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨è¯¥äº‹ä»¶å‘½
    // å­˜åœ¨å°†å›è°ƒpushåˆ°äº‹ä»¶åå¯¹åº”çš„valueæ•°ç»„ä¸­ï¼Œä¸å­˜åœ¨ç›´æ¥æ–°å¢
    this._listener[type]
      ? this._listener[type].push(fn)
      : (this._listener[type] = [fn])
  }

  // å‘å¸ƒ è§¦å‘äº‹ä»¶
  trigger(type, ...rest) {
    // åˆ¤æ–­è¯¥è§¦å‘äº‹ä»¶æ˜¯å¦å­˜åœ¨
    if (!this._listener[type]) return
    // éå†æ‰§è¡Œè¯¥äº‹ä»¶å›è°ƒæ•°ç»„å¹¶ä¼ é€’å‚æ•°
    this._listener[type].forEach((callback) => callback(...rest))
  }
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`Emitter`ç±»ï¼Œå¹¶ä¸”æ·»åŠ äº†ä¸¤ä¸ªåŸå‹æ–¹æ³•`on`å’Œ`trigger`ï¼Œä¸Šé¢ä»£ç ä¸­å‡æœ‰æ³¨é‡Šï¼Œæ‰€ä»¥ä¸è¿‡å¤šè§£é‡Šäº†ï¼ŒåŸºç¡€ä¸å¥½çš„åŒå­¦å¤šçœ‹å‡ éè‡ªå·±æ•²ä¸€ä¸‹ï¼Œæ¯”è¾ƒç®€å•

ä½¿ç”¨æ—¶

```js
// åˆ›å»ºä¸€ä¸ªemitterå®ä¾‹
const emitter = new Emitter()

emitter.on("done", function (arg1, arg2) {
  console.log(arg1, arg2)
})

emitter.on("done", function (arg1, arg2) {
  console.log(arg2, arg1)
})

function fn1() {
  console.log("æˆ‘æ˜¯ä¸»ç¨‹åº")
  setTimeout(() => {
    emitter.trigger("done", "å¼‚æ­¥å‚æ•°ä¸€", "å¼‚æ­¥å‚æ•°äºŒ")
  }, 1000)
}

fn1()
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª emitter å®ä¾‹ï¼Œæ¥ç€æ³¨å†Œäº‹ä»¶ï¼Œå†è§¦å‘äº‹ä»¶ï¼Œç”¨æ³•å’Œä¸Šé¢ JQ é›·åŒï¼Œå‡è§£å†³äº†å¼‚æ­¥é—®é¢˜

Vue çš„å®ç°å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œä½¿ç”¨ Vue çš„åŒå­¦ï¼Œä¸Šé¢çš„è¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼ŒæŠŠ`trigger`åå­—æ”¹æˆ`emit`æ˜¯ä¸æ˜¯å°±çœ¼ç†Ÿå¤šäº†ï¼Œå½“ç„¶æˆ‘ä»¬è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œæ¯•ç«Ÿä»£ç å°±é‚£ä¹ˆå…­ä¸ƒè¡Œï¼Œä¸è¿‡ç†æ˜¯è¿™ä¹ˆä¸ªç†

### äº‹ä»¶ç›‘å¬ä¼˜/ç¼º

**ä¼˜ç‚¹**

å‘å¸ƒè®¢é˜…æ¨¡å¼å®ç°çš„äº‹ä»¶ç›‘å¬ï¼Œæˆ‘ä»¬å¯ä»¥ç»‘å®šå¤šä¸ªäº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶ä¹Ÿå¯ä»¥æŒ‡å®šå¤šä¸ªå›è°ƒå‡½æ•°ï¼Œè¿˜æ˜¯æ¯”è¾ƒç¬¦åˆæ¨¡å—åŒ–æ€æƒ³çš„ï¼Œæˆ‘ä»¬è‡ªå†™ç›‘å¬å™¨æ—¶å¯ä»¥åšå¾ˆå¤šä¼˜åŒ–ä»è€Œæ›´å¥½çš„ç›‘æ§ç¨‹åºè¿è¡Œ

**ç¼ºç‚¹**

æ•´ä¸ªç¨‹åºå˜æˆäº†äº‹ä»¶é©±åŠ¨ï¼Œæµç¨‹ä¸Šæ¥è¯´æˆ–å¤šæˆ–å°‘éƒ½ä¼šæœ‰ç‚¹å½±å“ï¼Œæ¯æ¬¡ä½¿ç”¨è¿˜å¾—æ³¨å†Œäº‹ä»¶ç›‘å¬å†è¿›è¡Œè§¦å‘æŒºéº»çƒ¦çš„ï¼Œä»£ç ä¹Ÿä¸å¤ªä¼˜é›…ï¼Œå¹¶ä¸æ˜¯äº‹ä»¶é©±åŠ¨ä¸å¥½ï¼Œæ¯•ç«Ÿéœ€æ±‚åªæ˜¯ **è§£å†³å¼‚æ­¥é—®é¢˜** è€Œå·²ï¼Œä½•å†µæœ‰æ›´ä¼˜è§£

## Promise

### Promise ç®€è¿°

ES2015 (ES6)æ ‡å‡†åŒ–å’Œå¼•å…¥äº† Promise å¯¹è±¡ï¼Œå®ƒæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ

ç®€å•æ¥è¯´å°±æ˜¯ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥çš„ä»£ç ï¼Œå¯ç”¨æ¥è§£å†³å›è°ƒé—®é¢˜

### Promise ç‰¹ç‚¹

#### ç‰¹ç‚¹ä¸€

Promiseï¼Œæ‰¿è¯ºæ‰§è¡Œï¼ŒPromise å¯¹è±¡çš„çŠ¶æ€æ˜¯ä¸å—å¤–ç•Œå½±å“çš„

Promise å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå®ƒæœ‰ä¸‰ç§çŠ¶æ€

- è¿›è¡Œä¸­ (Pending)

- å·²å®Œæˆ (Resolved/Fulfilled)

- å·²å¤±è´¥ (Rejected)

åªæœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¯ä»¥å†³å®šå½“å‰æ˜¯å“ªä¸€ç§çŠ¶æ€ï¼Œä»»ä½•å…¶ä»–æ“ä½œéƒ½æ— æ³•æ”¹å˜è¿™ä¸ªçŠ¶æ€

è¿™å°±æ˜¯ Promise è¿™ä¸ªåå­—çš„ç”±æ¥ï¼Œå®ƒçš„è‹±è¯­æ„æ€å°±æ˜¯`æ‰¿è¯º`ï¼Œè¡¨ç¤ºå…¶ä»–æ‰‹æ®µæ— æ³•æ”¹å˜

#### ç‰¹ç‚¹äºŒ

Promise å¯¹è±¡çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜

Promise å¯¹è±¡çš„çŠ¶æ€æ”¹å˜ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½

- ä» Pending å˜ä¸º Resolved

- ä» Pending å˜ä¸º Rejected

åªè¦è¿™ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼ŒçŠ¶æ€å°±å‡å›ºï¼Œä¸ä¼šå†å˜äº†ï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœ

### Promise ä½¿ç”¨

Promise æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`new`å…³é”®å­—æ¥åˆ›å»ºä¸€ä¸ª Promise å®ä¾‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Promise çš„ä¸€äº›é™æ€æ–¹æ³•

#### new ä¸€ä¸ª Promise å®ä¾‹

**è¯­æ³•**

```js
new Promise( function(resolve, reject) {...});
```

**ç¤ºä¾‹**

```js
function fn1() {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      let num = Math.ceil(Math.random() * 10)
      if (num < 5) {
        resolve(num)
      } else {
        reject("æ•°å­—å¤ªå¤§")
      }
    }, 2000)
  })
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨`new`å…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ª promise å®ä¾‹ï¼Œå¹¶åœ¨å‡½æ•° fn1 ä¸­`return`äº†å‡ºæ¥

`new Promise`åˆ›å»ºäº†ä¸€ä¸ª promise å®ä¾‹ï¼ŒPromise æ„é€ å‡½æ•°ä¼šæŠŠä¸€ä¸ªå«åšå¤„ç†å™¨å‡½æ•°(executor function)çš„å‡½æ•°ä½œä¸ºå®ƒçš„å‚æ•°

å¤„ç†å™¨å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯`resolve`å’Œ`reject`ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸¤ä¸ªå›è°ƒå‡½æ•°

`resolve` å‡½æ•°åœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»

`reject` å‡½æ•°åœ¨å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œæŠ¥å‡ºçš„é”™è¯¯ï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»

ç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªæ˜¯æˆåŠŸå›è°ƒï¼Œä¸€ä¸ªæ˜¯å¤±è´¥å›è°ƒ

#### Promise.prototype.then()

Promise å¯¹è±¡æœ‰ä¸€ä¸ªåŸå‹æ–¹æ³•`then`

Promise å®ä¾‹ç”Ÿæˆä»¥åï¼Œå¯ä»¥ç”¨`then`æ–¹æ³•æŒ‡å®š`resolved`çŠ¶æ€å’Œ`reject`çŠ¶æ€çš„å›è°ƒå‡½æ•°

```js
Promise.prototype.then(onFulfilled[, onRejected])
```

`then`æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled å’Œ onRejected

- onFulfilled-å¯é€‰

  - å½“ Promise å˜æˆå·²å®ŒæˆçŠ¶æ€(fulfilled)æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°
  - è¯¥å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå³æ¥å—çš„æœ€ç»ˆç»“æœ(the fulfillment value)
  - å¦‚æœè¯¥å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ä¼šåœ¨å†…éƒ¨è¢«æ›¿æ¢ä¸º `(x) => x`ï¼Œå³åŸæ ·è¿”å› promise æœ€ç»ˆç»“æœçš„å‡½æ•°

- onRejected-å¯é€‰
  - å½“ Promise å˜æˆæ¥å—çŠ¶æ€æˆ–æ‹’ç»çŠ¶æ€(rejected)æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°
  - è¯¥å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå³æ‹’ç»çš„åŸå› (rejection reason)
  - å¦‚æœè¯¥å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ä¼šåœ¨å†…éƒ¨è¢«æ›¿æ¢ä¸ºä¸€ä¸ª `Thrower` å‡½æ•°(it throws an error it received as argument)

`then`æ–¹æ³•åœ¨æ¥æ”¶ä¸€ä¸ª promise å®ä¾‹åä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹(å¹¶ä¸æ˜¯åŸæ¥é‚£ä¸ª Promise å®ä¾‹)ï¼Œä¸”åŸæ¥çš„ promise å®ä¾‹çš„è¿”å›å€¼å°†ä½œä¸ºå‚æ•°ä¼ å…¥è¿™ä¸ªæ–° Promise çš„`resolve`å‡½æ•°

é‚£ä¹ˆæ—¢ç„¶`then`æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ promise å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¥ç€ä½¿ç”¨`then`æ–¹æ³•ï¼Œå³é“¾å¼è°ƒç”¨ï¼Œä¹Ÿè¢«ç§°ä¸º **å¤åˆ(composition)**æ“ä½œ

æ¥ä¸Šé¢çš„ç¤ºä¾‹ï¼Œå‡½æ•° fn1 ä¼šè¿”å›ä¸€ä¸ª promise å®ä¾‹

```js
fn1().then(
  (data) => {
    console.log(data)
  },
  (err) => {
    console.log(err)
  }
)
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`then`æ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°

ç¬¬ä¸€ä¸ªå‚æ•°å›è°ƒæˆ‘ä»¬å¾ˆå¸¸ç”¨ï¼Œå…¶å®å°±æ˜¯ Promise å˜æˆå·²å®ŒæˆçŠ¶æ€ä¸”æ‹¿åˆ°ä¼ é€’çš„å€¼

ç¬¬äºŒä¸ªå‚æ•°å›è°ƒå°±æ˜¯ Promise å˜æˆæ¥å—çŠ¶æ€æˆ–æ‹’ç»çŠ¶æ€ä¸”æ‹¿åˆ°é”™è¯¯å‚æ•°ï¼Œæˆ‘ä»¬å¯èƒ½ç”¨çš„å°‘ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨`catch`æ–¹æ³•ï¼Œ`then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° onRejected å’Œ`catch`è¿˜æ˜¯æœ‰ä¸€äº›ç»†å¾®åŒºåˆ«çš„ï¼Œä¸‹é¢ä¼šæåˆ°

æ ¹æ® Promises/A+ä¸­å¯¹`then`æ–¹æ³•çš„å®šä¹‰ï¼Œæˆ‘ä»¬æ¥çœ‹`then`æ–¹æ³•çš„ç‰¹ç‚¹

**é¦–å…ˆ`then` æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª `promise` å¯¹è±¡(åˆ’é‡ç‚¹)**

é“¾å¼è°ƒç”¨çš„åŸç†ï¼Œä¸è®ºæ˜¯ä½•ç§æƒ…å†µ then æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œè¿™æ ·æ‰ä¼šæœ‰ä¸‹ä¸ª then æ–¹æ³•

**å¦‚æœ`then`æ–¹æ³•ä¸­è¿”å›çš„æ˜¯ä¸€ä¸ªæ™®é€šå€¼(å¦‚ Numberã€String ç­‰)å°±ä½¿ç”¨æ­¤å€¼åŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡è¿”å›**

å°±åƒä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œ`then`æ–¹æ³•æ¥æ”¶ Promise å¯¹è±¡ï¼Œ`then`æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªæ™®é€šå€¼æ—¶ï¼Œä¸‹ä¸€ä¸ª`then`ä¸­æ˜¯å¯ä»¥æ¥åˆ°çš„

```js
let p = new Promise((resolve, reject) => {
  resolve(1)
})

p.then((data) => {
  return 2 // è¿”å›äº†ä¸€ä¸ªæ™®é€šå€¼
}).then((data) => {
  console.log(data) // 2
})
```

**å¦‚æœ`then`æ–¹æ³•ä¸­æ²¡æœ‰`return`è¯­å¥ï¼Œå°±è¿”å›ä¸€ä¸ªç”¨ Undefined åŒ…è£…çš„ Promise å¯¹è±¡**

å¦‚ä¸‹é¢ä¾‹å­çš„è¾“å‡ºç»“æœ

```js
let p = new Promise((resolve, reject) => {
  resolve(1)
})

p.then((data) => {
  // æ— returnè¯­å¥
}).then((data) => {
  console.log(data) // undefined
})
```

**å¦‚æœ`then`æ–¹æ³•ä¸­å‡ºç°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨å¤±è´¥æ€æ–¹æ³•(reject)è·³è½¬åˆ°ä¸‹ä¸€ä¸ª`then`çš„ onRejected**

`then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° onRejected æ˜¯ç›‘æµ‹ä¸åˆ°å½“å‰`then`æ–¹æ³•å›è°ƒå¼‚å¸¸çš„ï¼Œè§„èŒƒä¸­å®šä¹‰å½“å‰`then`æ–¹æ³•å‡ºç°å¼‚å¸¸åˆ™è°ƒç”¨å¤±è´¥æ€æ–¹æ³•(reject)æµè½¬åˆ°ä¸‹ä¸€ä¸ª`then`çš„ onRejected

```js
let p = new Promise((resolve, reject) => {
  resolve(1)
})

p.then((data) => 2)
  .then(
    (data) => {
      throw "this is err"
    },
    (err) => {
      console.log("err1:" + err)
    }
  )
  .then(
    (data) => {
      console.log(data)
    },
    (err) => {
      console.log("err2:" + err) // err2:this is err
    }
  )
```

**å¦‚æœ`then`æ–¹æ³•æ²¡æœ‰ä¼ å…¥ä»»ä½•å›è°ƒï¼Œåˆ™ç»§ç»­å‘ä¸‹ä¼ é€’(å³æ‰€è°“çš„å€¼ç©¿é€)**

ä¸‹é¢ç¤ºä¾‹ï¼Œåœ¨ç¬¬ä¸€ä¸ª`then`æ–¹æ³•ä¹‹åè¿ç»­è°ƒç”¨äº†ä¸¤ä¸ªç©ºçš„`then`æ–¹æ³• ï¼Œæ²¡æœ‰ä¼ å…¥ä»»ä½•å›è°ƒå‡½æ•°ï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼ï¼Œæ­¤æ—¶ Promise ä¼šå°†å€¼ä¸€ç›´å‘ä¸‹ä¼ é€’ï¼Œç›´åˆ°æ¥æ”¶å¤„ç†ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å€¼ç©¿é€

```js
let p = new Promise((resolve, reject) => {
  resolve(1)
})

p.then((data) => 2)
  .then()
  .then()
  .then((data) => {
    console.log(data) // 2
  })
```

**å¦‚æœ`then`æ–¹æ³•ä¸­è¿”å›äº†ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£å°±ä»¥è¿™ä¸ªå¯¹è±¡ä¸ºå‡†ï¼Œè¿”å›å®ƒçš„ç»“æœ**

è¯ä¸å¤šè¯´ï¼Œæ¥çœ‹ç¤ºä¾‹

```js
let p = new Promise((resolve, reject) => {
  resolve(1)
})

p.then((data) => {
  return new Promise((resolve, reject) => {
    resolve(2)
  })
}).then((data) => {
  console.log(data) // 2
})
```

#### Promise.prototype.catch()

é™¤äº†åŸå‹æ–¹æ³•`then`ä¹‹å¤–ï¼ŒPromise å¯¹è±¡è¿˜æœ‰ä¸€ä¸ª`catch`çš„åŸå‹æ–¹æ³•

`catch`æ–¹æ³•å¯ä»¥ç”¨äº promise ç»„åˆä¸­çš„é”™è¯¯å¤„ç†ï¼Œæ­¤æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µ

```js
p.catch(onRejected)

p.catch(function (reason) {
  // æ‹’ç»
})
```

- onRejected
  - å½“ Promise è¢« rejected æ—¶ï¼Œè¢«è°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°æ‹¥æœ‰ä¸€ä¸ªå‚æ•°ä¸ºå¤±è´¥åŸå› æˆ–é”™è¯¯ä¿¡æ¯

ç®€å•ç†è§£å°±æ˜¯æ•è·å¼‚å¸¸ï¼Œpromise ç»„åˆä¸­æŠ›å‡ºäº†é”™è¯¯æˆ– promise ç»„åˆä¸­å‡ºç° rejected ä¼šè¢«æ•è·

åŒæ ·æ¥æœ€ä¸Šé¢çš„ç¤ºä¾‹ï¼Œè¿˜ä½¿ç”¨ fn1 å‡½æ•°

```js
fn1()
  .then((data) => {
    console.log(data)
  })
  .catch((err) => {
    console.log(err)
  })
```

ä½¿ç”¨è¿™ç§æ–¹å¼æ•è·é”™è¯¯æˆ–å¤±è´¥æ˜¯ä¸æ˜¯æ¯”`then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°çœ‹ç€èˆ’æœäº†ç‚¹å‘¢ï¼Œæ¯•ç«Ÿ Promise å°±æ˜¯é“¾å¼åˆ°åº•

åŒæ ·ä¹Ÿéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œ`catch`æ–¹æ³•ä¹Ÿè¿”å›ä¸€ä¸ªæ–°çš„ promise å®ä¾‹ï¼Œå¦‚æœ `onRejected`å›è°ƒæŠ›å‡ºä¸€ä¸ªé”™è¯¯æˆ–è¿”å›ä¸€ä¸ªæœ¬èº«å¤±è´¥çš„ Promise ï¼Œé€šè¿‡ `catch` è¿”å›çš„ Promise ä¼šè¢« rejectedï¼Œå¦åˆ™ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæˆåŠŸçš„(resolved)promise å®ä¾‹

å’Œä¸Šé¢çš„`then`æ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°å‡ ä¹æ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬çœ‹ä¾‹å­

```js
fn1()
  .catch((err) => {
    console.log(err)
    return err
  })
  .then((data) => {
    console.log(data)
  })
  .catch((err) => {
    console.log(err)
  })
```

ä¸Šé¢çš„ fn1 å‡½æ•°æœ‰ä¸€åŠçš„å‡ ç‡è¿”å›ä¸€ä¸ª rejectedï¼Œå½“è¿”å›ä¸€ä¸ª rejected æ—¶ä¸‹é¢çš„`then`æ–¹æ³•å›è°ƒä¸­åŒæ ·ä¼šè¾“å‡ºï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ª`catch`ä¸­åª return äº†é”™è¯¯ä¿¡æ¯ï¼Œå¹¶æ²¡æœ‰æŠ›å‡ºé”™è¯¯æˆ–è€…è¿”å›ä¸€ä¸ªå¤±è´¥ promiseï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª`catch`æ‰§è¡Œè¿”å›çš„ promise å¯¹è±¡æ˜¯ resolveing

#### Promise.prototype.finally()

finallyï¼Œè‹±æ–‡æ˜¯`æœ€å`çš„æ„æ€ï¼Œæ­¤æ–¹æ³•æ˜¯`ES2018`çš„æ ‡å‡†

åŸå‹æ–¹æ³•`finally`ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„å¯èƒ½ä¸å¤šï¼Œè¯­æ³•å¦‚ä¸‹

```js
p.finally(onFinally)

p.finally(function () {
  // è¿”å›çŠ¶æ€ä¸º(resolved æˆ– rejected)
})
```

ä¸€å¥è¯å³å¯è§£é‡Š`finally`ï¼Œåœ¨ promise ç»“æŸæ—¶ï¼Œä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½å°†æ‰§è¡Œå…¶`onFinally`å›è°ƒï¼Œè¯¥å›è°ƒæ— å‚æ•°

é€‚ç”¨äºåŒæ ·çš„è¯­å¥éœ€è¦åœ¨`then()`å’Œ`catch()`ä¸­å„å†™ä¸€æ¬¡çš„æƒ…å†µ

#### Promise.resolve()

ä¸€å¥è¯æ¦‚æ‹¬ Promise.resolve()æ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªå€¼ï¼Œå°†ç°æœ‰å¯¹è±¡è½¬ä¸º Promise å¯¹è±¡

```js
Promise.resolve(value)
```

å¦‚ä¸‹æ‰€ç¤ºï¼Œè¯¥å€¼å¯ä¸ºä»»æ„ç±»å‹ï¼Œä¹Ÿå¯æ˜¯ä¸€ä¸ª Promise å¯¹è±¡

```js
const p = Promise.resolve(123)

Promise.resolve(p).then((value) => {
  console.log(value) // 123
})
```

#### Promise.reject()

`Promise.reject()`æ–¹æ³•åŒä¸Šé¢`Promise.resolve()`ä¸€æ ·ï¼Œåªä¸è¿‡æ˜¯è¿”å›ä¸€ä¸ªå¸¦æœ‰æ‹’ç»åŸå› çš„`Promise`å¯¹è±¡

```js
Promise.reject(123)
  .then((data) => {
    console.log(data)
  })
  .catch((err) => {
    console.log("err:" + err)
  })

// err:123
```

#### Promise.all()

`Promise.all(iterable)`ç”¨äºå°†å¤šä¸ª Promise å®ä¾‹åŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œå‚æ•°ä¸ºä¸€ç»„ Promise å®ä¾‹ç»„æˆçš„æ•°ç»„

iterable ç±»å‹ä¸º ES6 æ ‡å‡†å¼•å…¥ï¼Œä»£è¡¨å¯è¿­ä»£å¯¹è±¡ï¼Œ`Array`ã€`Map`å’Œ`Set`éƒ½å±äº`iterable`ç±»å‹ ï¼Œiterable ä¸‹é¢æˆ‘ä»¬ä¼šè®²åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å…ˆæŠŠè¿™ä¸ªå‚æ•°ç†è§£æˆæ•°ç»„å°±å¯ä»¥ï¼Œç¨åé…åˆä¸‹é¢çš„ iterable æ¥ç†è§£

```js
let p1 = Promise.resolve(1)
let p2 = Promise.resolve(2)
let p3 = Promise.resolve(3)

let p = Promise.all([p1, p2, p3])

p.then((data) => {
  console.log(data) // [1,2,3]
})
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œå½“ p1, p2, p3 çŠ¶æ€éƒ½ Resolved çš„æ—¶å€™ï¼Œp çš„çŠ¶æ€æ‰ä¼š Resolved

åªè¦æœ‰ä¸€ä¸ªå®ä¾‹ Rejected ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªè¢« Rejected çš„å®ä¾‹è¿”å›å€¼å°±ä¼šä¼ é€’ç»™ P çš„å›è°ƒå‡½æ•°

```js
let p1 = Promise.resolve(1)
let p2 = Promise.resolve(2)
let p3 = Promise.reject(3)

let p = Promise.all([p1, p2, p3])
p.then((data) => {
  console.log(data)
}).catch((err) => {
  console.log("err:" + err) // 3
})
```

åº”ç”¨åœºæ™¯åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¥å£ï¼Œéœ€è¦å…¶ä»–ä¸¤ä¸ªæˆ–å¤šä¸ªæ¥å£è¿”å›çš„æ•°æ®ä½œä¸ºå‚æ•°æ—¶ä¼šå¤šä¸€äº›

#### Promise.race()

`Promise.race(iterable)`å’Œä¸Šé¢`Promise.all(iterable)`ç±»ä¼¼

`all`æ–¹æ³•æ˜¯è¿­ä»£å¯¹è±¡ä¸­çŠ¶æ€å…¨éƒ¨æ”¹å˜æ‰ä¼šæ‰§è¡Œ

`race`æ–¹æ³•æ­£å¥½ç›¸åï¼Œåªè¦è¿­ä»£å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªçŠ¶æ€æ”¹å˜äº†ï¼Œå®ƒçš„çŠ¶æ€å°±è·Ÿç€æ”¹å˜ï¼Œå¹¶å°†é‚£ä¸ªæ”¹å˜çŠ¶æ€å®ä¾‹çš„è¿”å›å€¼ä¼ é€’ç»™å›è°ƒå‡½æ•°

```js
const p1 = new Promise((resolve, reject) => {
  setTimeout(resolve, 1000, "1")
})

const p2 = new Promise((resolve, reject) => {
  setTimeout(resolve, 500, "2")
})

Promise.race([p1, p2]).then((value) => {
  console.log(value) // 2
})
```

#### Promise.try()

å¼€å‘ä¸­ï¼Œç»å¸¸é‡åˆ°ä¸€ç§æƒ…å†µï¼šä¸çŸ¥é“æˆ–ä¸æƒ³åŒºåˆ†ï¼Œå‡½æ•° fn æ˜¯åŒæ­¥å‡½æ•°è¿˜æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œä½†æƒ³ç”¨ Promise æ¥å¤„ç†å®ƒ

å› ä¸ºè¿™æ ·å°±å¯ä»¥ä¸ç®¡ fn æ˜¯ä¸æ˜¯å¼‚æ­¥æ“ä½œï¼Œéƒ½ç”¨ then æ–¹æ³•æŒ‡å®šä¸‹ä¸€æ­¥æµç¨‹ï¼Œç”¨ catch æ–¹æ³•å¤„ç† fn æŠ›å‡ºçš„é”™è¯¯

æˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨`Promise.resolve`æŠŠå®ƒè½¬æ¢æˆ Promise å¯¹è±¡

```js
let fn = () => console.log("fn")
Promise.resolve(fn).then((cb) => cb())
console.log("hahaha")

// hahaha
// fn
```

ä½†æ˜¯è¿™æ ·æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå‡½æ•° fn æ˜¯åŒæ­¥çš„ï¼Œé‚£ä¹ˆè¿™æ³¢æ“ä½œä¼šæŠŠå®ƒè½¬æˆå¼‚æ­¥ï¼Œå¦‚ä¸Šè¾“å‡º

é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œè®©åŒæ­¥å‡½æ•°åŒæ­¥æ‰§è¡Œï¼Œå¼‚æ­¥å‡½æ•°å¼‚æ­¥æ‰§è¡Œï¼Œå¹¶ä¸”è®©å®ƒä»¬å…·æœ‰ç»Ÿä¸€çš„ API å‘¢ï¼Ÿå½“ç„¶å¯ä»¥

æˆ‘ä»¬å¯ä»¥è¿™æ ·

```js
const fn = () => console.log("fn")
;(() => new Promise((resolve) => resolve(fn())))()
  .then(() => {
    console.log(222)
  })
  .catch((err) => {
    console.log(err)
  })

console.log("111")

// fn
// 111
// 222
```

ä¹Ÿå¯ä»¥è¿™æ ·

```js
const fn = () => console.log("fn")
;(async () => fn())()
  .then(() => {
    console.log(222)
  })
  .catch((err) => {
    console.log(err)
  })

console.log("111")

// fn
// 111
// 222
```

ä½†æ˜¯ï¼Œä»£ç æœ‰ç‚¹è¯¡å¼‚ï¼Œä¸ä¼˜é›…

æ¥çœ‹ä½¿ç”¨`try`æ–¹æ³•

```js
const fn = () => console.log("fn")
Promise.try(fn)
  .then(() => {
    console.log(222)
  })
  .catch((err) => {
    console.log(err)
  })

console.log("111")

// fn
// 111
// 222
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œç®€æ´æ˜äº†ï¼Œè¿˜æ˜¯å¾ˆå®ç”¨çš„

å…¶å®ï¼Œ`Promise.try`å°±æ˜¯æ¨¡æ‹Ÿ try ä»£ç å—ï¼Œå°±åƒ`promise.catch`æ¨¡æ‹Ÿçš„æ˜¯ catch ä»£ç å—

æœ€å `Promise.try` å¹¶ä¸æ˜¯ Javascript çš„ä¸€éƒ¨åˆ†

æ—©åœ¨ 16 å¹´æœ‰è¿‡è¿™ä¸ªææ¡ˆï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸‹ï¼Œç°åœ¨ä¹Ÿæ²¡ä¸‹æ–‡äº†ï¼Œå¹¶æ²¡æœ‰è¢«çº³å…¥æ ‡å‡†

å¦‚æœæƒ³è¦ä½¿ç”¨çš„è¯ï¼Œéœ€è¦ä½¿ç”¨ Promise åº“ Bluebirdã€Q ç­‰ï¼Œæˆ–å¼•å…¥ Polyfill

è™½ç„¶æ²¡æœ‰è¢«çº³å…¥æ ‡å‡†ï¼Œä½†å¹¶ä¸ä»£è¡¨å®ƒä¸å¥½ç”¨ï¼Œå¤§å®¶è‡ªè¡Œä½“éªŒ

æƒ³è¦äº†è§£æ›´å¤šæ­¤æ–¹æ³•æ¨èå¤§å®¶çœ‹å‚è€ƒé“¾æ¥ã€4ã€‘ã€5ã€‘

#### onRejected å’Œ catch åŒºåˆ«

ä¸Šé¢æåˆ°äº†`promise.then(onFulfilled, onRejected)`ä¸­çš„ç¬¬äºŒä¸ªå‚æ•° onRejected å’Œ`catch`

çœ‹åˆ°è¿™å¤§å®¶å¯èƒ½ä¼šé—®ï¼ŒåŒæ ·éƒ½æ˜¯æ•è·å¼‚å¸¸å®ƒä»¬çš„åŒºåˆ«åœ¨å“ª

å…¶å®`promise.then(onFulfilled, onRejected)` åœ¨ `onFulfilled`å›è°ƒä¸­å‘ç”Ÿå¼‚å¸¸çš„è¯ï¼Œåœ¨`onRejected`ä¸­æ˜¯æ•è·ä¸åˆ°è¿™ä¸ªå¼‚å¸¸çš„ï¼Œä½¿ç”¨`catch`å¯ä»¥æ•è·åˆ°å‰é¢çš„ onFulfilled çš„å¼‚å¸¸

å…¶å®è¿™ä¸ç®—ä¸ªç¼ºç‚¹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨æœ«å°¾å¤šåŠ ä¸€ä¸ª`then`ä»è€Œè¾¾åˆ°å’Œ`catch`ç›¸åŒçš„ä½œç”¨ï¼Œå¦‚ä¸‹

```js
Promise.reject(1)
  .then(() => {
    console.log("æˆ‘æ˜¯å¯¹çš„")
  })
  .then(null, (err) => {
    console.log("err:" + err) // err:1
  })

// ç­‰ä»·äº

Promise.reject(1)
  .then(() => {
    console.log("æˆ‘æ˜¯å¯¹çš„")
  })
  .catch((err) => {
    console.log("err:" + err) // err:1
  })
```

å°±è¿™ä¹ˆç‚¹åŒºåˆ«ï¼Œä¸è¿‡å¤§éƒ¨åˆ†äººéƒ½å–œæ¬¢ç›´æ¥ä½¿ç”¨`catch`ç½¢äº†

#### then ä¸­æŠ›é”™æœªå¤„ç†

å¦‚æœåœ¨ then ä¸­æŠ›é”™ï¼Œè€Œæ²¡æœ‰å¯¹é”™è¯¯è¿›è¡Œå¤„ç†(catch)ï¼Œé‚£ä¹ˆä¼šä¸€ç›´ä¿æŒ reject çŠ¶æ€ï¼Œç›´åˆ° catch äº†é”™è¯¯

æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç 

```js
Promise.resolve()
  .then(() => {
    console.log(a)
    console.log("Task 1")
  })
  .then(() => {
    console.log("Task 2")
  })
  .catch((err) => {
    console.log("err:" + err)
  })
  .then(() => {
    console.log("finaltask")
  })

// err:ReferenceError: a is not defined
// finaltask
```

æˆ‘ä»¬çœ‹ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ª`then`ä¸­è¾“å‡ºäº†ä¸€ä¸ªæœªå£°æ˜çš„å˜é‡

è¾“å‡ºç»“æœå…ˆèµ°äº†`catch`ç„¶åèµ°äº†æœ€åä¸€ä¸ª`then`ï¼Œç¬¬ä¸€ä¸ª`then`ä¸­æŠ›å‡ºé”™è¯¯å¹¶è·³è¿‡äº†ç¬¬äºŒä¸ª`then`

ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ²¡æœ‰å¤„ç†è¿™ä¸ªé”™è¯¯(æ—  catch)çš„è¯ï¼Œå°±ä¸ä¼šå¾€ä¸‹æ‰§è¡Œäº†

å¯å‚è€ƒä¸‹å›¾

![image-20200201231714043](https://gitee.com/IsboyJC/PictureBed/raw/master/other/image-20200201231714043.png)

promise çš„ç¼ºç‚¹ä¹‹ä¸€å°±æ˜¯æ— æ³•è®© promise ä¸­æ–­ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥è®© Promise ä¸­æ–­æ‰§è¡Œï¼Œä¹Ÿç®—ä¸€ç§åŠæ³•å§

#### å¼‚æ­¥å›è°ƒä¸­æŠ›é”™ catch æ•æ‰ä¸åˆ°

é¦–å…ˆæˆ‘ä»¬çœ‹åœ¨ Promise å¯¹è±¡çš„å¤„ç†å™¨å‡½æ•°ä¸­ç›´æ¥æŠ›å‡ºé”™è¯¯

```js
const p = new Promise((resolve, reject) => {
  throw new Error("è¿™æ˜¯ä¸€ä¸ªé”™è¯¯")
})
p.catch((error) => {
  console.log(error)
})
```

æŒ‰ç…§ä¸Šè¿°å†…å®¹æ¥çœ‹ï¼Œåœ¨ Promise å¯¹è±¡çš„å¤„ç†å™¨å‡½æ•°ä¸­ç›´æ¥æŠ›å‡ºé”™è¯¯ï¼Œ`catch`æ˜¯å¯ä»¥æ•æ‰åˆ°çš„

åœ¨ä¸‹é¢ä»£ç ï¼Œåœ¨ Promise å¯¹è±¡çš„å¤„ç†å™¨å‡½æ•°ä¸­æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥æŠ›é”™

```js
const p = new Promise((resolve, reject) => {
  setTimeout(() => {
    throw new Error("è¿™æ˜¯ä¸€ä¸ªé”™è¯¯")
  }, 0)
})
p.catch((error) => {
  console.log(error)
})
```

è¿™ç§æƒ…å†µ`catch`æ˜¯æ•æ‰ä¸åˆ°çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…ˆæƒ³åçœ‹ï¼Œå†åšä¸éš¾

**åŸå› **

JS äº‹ä»¶å¾ªç¯åˆ—è¡¨æœ‰å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ä¹‹åˆ†ï¼ŒsetTimeOut æ˜¯å®ä»»åŠ¡ï¼Œ promise æ˜¯å¾®ä»»åŠ¡ï¼Œæ‰§è¡Œé¡ºåºä¸åŒ

é‚£ä¹ˆè¿™æ®µä»£ç çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š

1. ä»£ç æ‰§è¡Œæ ˆè¿›å…¥ promise è§¦å‘ setTimeOutï¼ŒsetTimeOut å›è°ƒå‡½æ•°å…¥å®ä»»åŠ¡é˜Ÿåˆ—
2. ä»£ç æ‰§è¡Œ promise çš„ catch æ–¹æ³•ï¼Œå…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ­¤æ—¶ setTimeOut å›è°ƒè¿˜æ²¡æœ‰æ‰§è¡Œ
3. æ‰§è¡Œæ ˆæ£€æŸ¥å‘ç°å½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—
4. æ‰§è¡Œ`throw new Error('è¿™æ˜¯ä¸€ä¸ªé”™è¯¯')` æ­¤æ—¶è¿™ä¸ªå¼‚å¸¸å…¶å®æ˜¯åœ¨ promise å¤–éƒ¨æŠ›å‡ºçš„

**è§£å†³**

ä½¿ç”¨`try catch`æ•è·å¼‚å¸¸ä¸»åŠ¨è§¦å‘`reject`

```js
const p = new Promise((resolve, reject) => {
  setTimeout(() => {
    try {
      throw new Error("è¿™æ˜¯ä¸€ä¸ªé”™è¯¯")
    } catch (e) {
      reject(e)
    }
  }, 0)
})
p.catch((error) => {
  console.log(error)
})
```

### æ‰‹å†™ Promiseâ€”ç¬¦åˆ Promises/A+è§„èŒƒ

#### ä¸ºä»€ä¹ˆè¦æ‰‹å†™ Promise

Promise æºç é€»è¾‘ç›¸å¯¹æ¥è¯´ä¸ç®—ç®€å•ï¼Œå¯èƒ½æˆ‘ä»¬åªä¼šä½¿ç”¨ï¼Œå¹¶ä¸æ¸…æ¥šå…¶åŸç†

è‡ªå·±å®ç°ä¸€éä¼šåŠ æ·±æˆ‘ä»¬å¯¹ Promise çš„ç†è§£ï¼Œä¹Ÿå¯ä»¥åŠ å¼ºæˆ‘ä»¬ JS çš„åŠŸåº•

æ›´ä½•å†µæ‰‹å†™å®ç° Promise æ˜¯ä¸€é“å‰ç«¯ç»å…¸çš„é¢è¯•é¢˜ï¼Œæ­¤å¤„å¿…ç„¶ä¸ç”¨å¤šè¯´

#### Promises/A+

äº†è§£äº† Promise çš„åŸºç¡€ç”¨æ³•åï¼Œæˆ‘ä»¬æ¥ä¸€æ­¥æ­¥å€’æ¨å®ç° Promise

Promises/A+æ ‡å‡†æ˜¯ä¸€ä¸ªå¼€æ”¾ã€å¥å…¨ä¸”é€šç”¨çš„ JavaScript Promise æ ‡å‡†ï¼Œç”±å¼€å‘è€…åˆ¶å®šï¼Œä¾›å¼€å‘è€…å‚è€ƒ

å¾ˆå¤š Promise ä¸‰æ–¹åº“éƒ½æ˜¯æŒ‰ç…§ Promises/A+æ ‡å‡†å®ç°çš„

soï¼Œæ­¤æ¬¡å®ç°æˆ‘ä»¬ä¸¥æ ¼ Promises/A+æ ‡å‡†ï¼ŒåŒ…æ‹¬å®Œæˆåæˆ‘ä»¬ä¼šä½¿ç”¨å¼€æºç¤¾åŒºæä¾›çš„æµ‹è¯•åŒ…æ¥æµ‹è¯•

ç®€å•æ¥è¯´ï¼Œæµ‹è¯•é€šè¿‡çš„è¯ï¼Œè¶³ä»¥è¯æ˜ä»£ç ç¬¦åˆ Promises/A+æ ‡å‡†ï¼Œæ˜¯åˆæ³•çš„ã€å®Œå…¨å¯ä»¥ä¸Šçº¿æä¾›ç»™ä»–äººä½¿ç”¨çš„

æ›´å¤š Promises/A+æ ‡å‡†è¯·çœ‹å‚è€ƒé“¾æ¥ã€6ã€‘ã€7ã€‘

#### æ„é€ æ–¹æ³•æ ¸å¿ƒåŸºç¡€æ­å»º

Promise çš„ç”¨æ³•ä¸Šé¢å·²ç»è¯¦ç»†è®²äº†ï¼Œå¦‚æœé˜…è¯»ä»”ç»†çš„è¯ï¼Œæˆ‘ä»¬ä¼šçŸ¥é“

- Promise æœ‰ä¸‰ç§çŠ¶æ€è¿›è¡Œä¸­ (Pending)ã€å·²å®Œæˆ (Resolved/Fulfilled)å’Œå·²å¤±è´¥ (Rejected)
- Promise æ˜¯ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå®ä¾‹åŒ– Promise æ—¶ä¼ å…¥ä¸€ä¸ªå‡½æ•°ä½œä¸ºå¤„ç†å™¨
  - å¤„ç†å™¨å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°(resolve å’Œ reject)åˆ†åˆ«å°†ç»“æœå˜ä¸ºæˆåŠŸæ€å’Œå¤±è´¥æ€
  - Promise å¯¹è±¡æ‰§è¡ŒæˆåŠŸäº†è¦æœ‰ä¸€ä¸ªç»“æœï¼Œé€šè¿‡ resolve ä¼ é€’å‡ºå»ï¼Œå¤±è´¥çš„è¯å¤±è´¥åŸå› é€šè¿‡ reject ä¼ é€’å‡ºå…¥
- Promise çš„åŸå‹ä¸Šå®šä¹‰ç€ then æ–¹æ³•

é‚£ä¹ˆæ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„è¿™äº›å·²çŸ¥éœ€æ±‚æˆ‘ä»¬å¯ä»¥å†™å‡ºä¸€ä¸ªåŸºç¡€çš„ç»“æ„(å†™æ³•åƒåƒä¸‡ï¼Œå–œæ¬¢ class ä¹Ÿå¯ä»¥ç”¨ class)

```js
function Promise(executor) {
  // çŠ¶æ€æè¿° pending resolved rejected
  this.state = "pending"
  // æˆåŠŸç»“æœ
  this.value = undefined
  // å¤±è´¥åŸå› 
  this.reason = undefined

  function resolve(value) {}

  function reject(reason) {}
}

Promise.prototype.then = function (onFulfilled, onRejected) {}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Promise æ„é€ æ–¹æ³•ï¼Œ`state`å±æ€§ä¿å­˜äº† Promise å¯¹è±¡çš„çŠ¶æ€ï¼Œä½¿ç”¨`value`å±æ€§ä¿å­˜ Promise å¯¹è±¡æ‰§è¡ŒæˆåŠŸçš„ç»“æœï¼Œå¤±è´¥åŸå› ä½¿ç”¨`reason`å±æ€§ä¿å­˜ï¼Œè¿™äº›å‘½åå®Œå…¨è´´åˆ Promises/A+æ ‡å‡†

æ¥ç€æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†`resolve`å’Œ`reject`ä¸¤ä¸ªæ–¹æ³•ï¼Œç„¶ååœ¨æ„é€ å‡½æ•°çš„åŸå‹ä¸Šåˆ›å»ºäº†ä¸€ä¸ª`then`æ–¹æ³•ï¼Œä»¥å¤‡å¾…ç”¨

#### åˆå§‹åŒ–å®ä¾‹ executor ç«‹å³æ‰§è¡Œ

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åˆ›å»ºä¸€ä¸ª Promise å®ä¾‹æ—¶ï¼Œå¤„ç†å™¨å‡½æ•°(executor)æ˜¯ä¼šç«‹å³æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´æ”¹ä»£ç 

```js
function Promise(executor) {
  this.state = "pending"
  this.value = undefined
  this.reason = undefined

  // è®©å…¶å¤„ç†å™¨å‡½æ•°ç«‹å³æ‰§è¡Œ
  try {
    executor(resolve, reject)
  } catch (err) {
    reject(err)
  }

  function resolve(value) {}
  function reject(reason) {}
}
```

#### resolve&reject å›è°ƒå®ç°

Promises/A+è§„èŒƒä¸­è§„å®šï¼Œå½“ Promise å¯¹è±¡å·²ç»ç”± pending çŠ¶æ€æ”¹å˜ä¸ºæˆåŠŸæ€(resolved)æˆ–å¤±è´¥æ€(rejected)åä¸å¯å†æ¬¡æ›´æ”¹çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆåŠŸæˆ–å¤±è´¥åçŠ¶æ€ä¸å¯æ›´æ–°å·²ç»å‡å›º

å› æ­¤æˆ‘ä»¬æ›´æ–°çŠ¶æ€æ—¶è¦åˆ¤æ–­ï¼Œå¦‚æœå½“å‰çŠ¶æ€æ˜¯ pending(ç­‰å¾…æ€)æ‰å¯æ›´æ–°ï¼Œç”±æ­¤æˆ‘ä»¬æ¥å®Œå–„`resolve`å’Œ`reject`æ–¹æ³•

```js
let _this = this

function resolve(value) {
  if (_this.state === "pending") {
    _this.value = value
    _this.state = "resolved"
  }
}

function reject(reason) {
  if (_this.state === "pending") {
    _this.reason = reason
    _this.state = "rejected"
  }
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨ Promise æ„é€ å‡½æ•°å†…éƒ¨ç”¨å˜é‡`_this`æ‰˜ç®¡æ„é€ å‡½æ•°çš„`this`

æ¥ç€æˆ‘ä»¬åœ¨`resolve`å’Œ`reject`å‡½æ•°ä¸­åˆ†åˆ«åŠ å…¥äº†åˆ¤æ–­ï¼Œå› ä¸ºåªæœ‰å½“å‰æ€æ˜¯ pending æ‰å¯è¿›è¡ŒçŠ¶æ€æ›´æ”¹æ“ä½œ

åŒæ—¶å°†æˆåŠŸç»“æœå’Œå¤±è´¥åŸå› éƒ½ä¿å­˜åˆ°å¯¹åº”çš„å±æ€§ä¸Š

ç„¶åå°† state å±æ€§ç½®ä¸ºæ›´æ–°åçš„çŠ¶æ€

#### then æ–¹æ³•åŸºç¡€å®ç°

æ¥ç€æˆ‘ä»¬æ¥ç®€å•å®ç°`then`æ–¹æ³•

é¦–å…ˆ`then`æ–¹æ³•æœ‰ä¸¤ä¸ªå›è°ƒï¼Œå½“ Promise çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼ŒæˆåŠŸæˆ–å¤±è´¥ä¼šåˆ†åˆ«è°ƒç”¨`then`æ–¹æ³•çš„ä¸¤ä¸ªå›è°ƒ

æ‰€ä»¥ï¼Œthen æ–¹æ³•çš„å®ç°çœ‹èµ·æ¥æŒºç®€å•ï¼Œæ ¹æ® state çŠ¶æ€æ¥è°ƒç”¨ä¸åŒçš„å›è°ƒå‡½æ•°å³å¯

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
  if (this.state === "resolved") {
    if (typeof onFulfilled === "function") {
      onFulfilled(this.value)
    }
  }
  if (this.state === "rejected") {
    if (typeof onRejected === "function") {
      onRejected(this.reason)
    }
  }
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œç”±äº`onFulfilled & onRejected`ä¸¤ä¸ªå‚æ•°éƒ½ä¸æ˜¯å¿…é€‰å‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ¤æ–­çŠ¶æ€ååˆåˆ¤æ–­äº†å‚æ•°ç±»å‹ï¼Œå½“å‚æ•°ä¸ä¸ºå‡½æ•°ç±»å‹ï¼Œå°±ä¸æ‰§è¡Œï¼Œå› ä¸ºåœ¨ Promises/A+è§„èŒƒä¸­å®šä¹‰éå‡½æ•°ç±»å‹å¯å¿½ç•¥

#### è®© Promise æ”¯æŒå¼‚æ­¥

å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè§‰å¾—ï¼Œå’¦ï¼ŸPromise å®ç°èµ·æ¥ä¹Ÿä¸éš¾å˜›ï¼Œè¿™ä¹ˆå¿«å°±æœ‰æ¨¡æœ‰æ ·äº†ï¼Œæˆ‘ä»¬æ¥ç®€å•æµ‹è¯•ä¸‹

```js
let p = new Promise((resolve, reject) => {
  resolve(1)
})

p.then((data) => console.log(data)) // 1
```

å—¯ï¼Œç¬¦åˆé¢„æœŸï¼Œå†æ¥è¯•ä¸‹å¼‚æ­¥ä»£ç 

```js
let p = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve(1);
  }ï¼Œ1000);
})

p.then(data => console.log(data)) // æ— è¾“å‡º
```

é—®é¢˜æ¥äº†ï¼ŒPromise ä¸€ä¸ªå¼‚æ­¥è§£å†³æ–¹æ¡ˆè¢«æˆ‘ä»¬å†™çš„ä¸æ”¯æŒå¼‚æ­¥ã€‚ã€‚ã€‚

æˆ‘ä»¬æ¥åˆ†æä¸‹ï¼Œæœ¬æ¥æ˜¯ç­‰ 1000ms åæ‰§è¡Œ`then`æ–¹æ³•ï¼Œè¿è¡Œä¸Šé¢ä»£ç å‘ç°æ²¡æœ‰ç»“æœï¼Œå“ªé‡Œæœ‰é—®é¢˜å‘¢ï¼Ÿ

setTimeout å‡½æ•°è®©`resolve`å˜æˆäº†å¼‚æ­¥æ‰§è¡Œï¼Œæœ‰å»¶è¿Ÿï¼Œè°ƒç”¨`then`æ–¹æ³•çš„æ—¶å€™ï¼Œæ­¤åˆ»çŠ¶æ€è¿˜æ˜¯ç­‰å¾…æ€(pending)ï¼Œ`then`æ–¹æ³•å³æ²¡æœ‰è°ƒç”¨`onFulfilled`ä¹Ÿæ²¡æœ‰è°ƒç”¨`onRejected`

å—¯ï¼Œæ¸…æ¥šåŸå› æˆ‘ä»¬å¼€å§‹æ”¹é€ ï¼Œå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šå¦‚ä½•è§£å†³å‘¢ï¼Œæ­¤å¤„å¯æ€è€ƒ 40 ç§’ï¼Œæƒ³ä¸€ä¸ªå¯å®æ–½çš„å¤§è‡´æ€è·¯

**å°æç¤ºï¼š** å¯ä»¥å‚è€ƒä¸Šæ–‡çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œå¦‚æœ 40 ç§’è¿˜æ²¡æœ‰æ€è·¯ï¼Œå—¯ï¼Œæœ‰å¾…æé«˜

|

|

-->ä¸ºäº†è®©æ‚¨å°å°æ´»åŠ¨ä¸€ä¸‹å·¦è„‘å¹¶æ´»è·ƒä¸‹æ°”æ°›ï¼Œæˆ‘ä¹Ÿæ˜¯ç…è´¹è‹¦å¿ƒ(**ps:**éƒ½çœ‹åˆ°è¿™äº†ï¼Œä¸ç‚¹ä¸ªèµé¼“åŠ±ä¸‹å°±å¤ªæ²¡åŠ²äº†å™» ğŸ˜„)

|

|

å›å½’æ­£é¢˜ï¼Œæˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜

æˆ‘ä»¬å¯ä»¥å‚ç…§å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œåœ¨æ‰§è¡Œ`then`æ–¹æ³•æ—¶å¦‚æœè¿˜åœ¨ç­‰å¾…æ€(pending)ï¼Œå°±æŠŠå›è°ƒå‡½æ•°ä¸´æ—¶å¯„å­˜åˆ°é˜Ÿåˆ—(å°±æ˜¯ä¸€ä¸ªæ•°ç»„)é‡Œï¼Œå½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ä¾æ¬¡ä»æ•°ç»„ä¸­å–å‡ºæ‰§è¡Œå°±å¥½äº†

æ€è·¯æœ‰äº†ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸‹

é¦–å…ˆï¼Œæˆ‘ä»¬è¦åœ¨æ„é€ æ–¹æ³•ä¸­æ–°å¢ä¸¤ä¸ª Array ç±»å‹çš„æ•°ç»„ï¼Œç”¨äºå­˜æ”¾æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°

```js
function Promise(executor) {
  let _this = this
  this.state = "pending"
  this.value = undefined
  this.reason = undefined
  // ä¿å­˜æˆåŠŸå›è°ƒ
  this.onResolvedCallbacks = []
  // ä¿å­˜å¤±è´¥å›è°ƒ
  this.onRejectedCallbacks = []
  // ...
}
```

æˆ‘ä»¬è¿˜éœ€è¦æ”¹å–„`then`æ–¹æ³•ï¼Œåœ¨`then`æ–¹æ³•æ‰§è¡Œæ—¶å¦‚æœçŠ¶æ€æ˜¯ç­‰å¾…æ€ï¼Œå°±å°†å…¶å›è°ƒå‡½æ•°å­˜å…¥å¯¹åº”æ•°ç»„

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
  // æ–°å¢ç­‰å¾…æ€åˆ¤æ–­ï¼Œæ­¤æ—¶å¼‚æ­¥ä»£ç è¿˜æœªèµ°å®Œï¼Œå›è°ƒå…¥æ•°ç»„é˜Ÿåˆ—
  if (this.state === "pending") {
    if (typeof onFulfilled === "function") {
      this.onResolvedCallbacks.push(onFulfilled)
    }
    if (typeof onRejected === "function") {
      this.onRejectedCallbacks.push(onRejected)
    }
  }

  // ä»¥ä¸‹ä¸ºä¹‹å‰ä»£ç å—
  if (this.state === "resolved") {
    if (typeof onFulfilled === "function") {
      onFulfilled(this.value)
    }
  }
  if (this.state === "rejected") {
    if (typeof onRejected === "function") {
      onRejected(this.reason)
    }
  }
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬æ”¹å†™`then`æ–¹æ³•ï¼Œé™¤äº†åˆ¤æ–­æˆåŠŸæ€(resolved)ã€å¤±è´¥æ€(rejected)ï¼Œæˆ‘ä»¬åˆåŠ äº†ä¸€ä¸ªç­‰å¾…æ€(pending)åˆ¤æ–­ï¼Œå½“çŠ¶æ€ä¸ºç­‰å¾…æ€æ—¶ï¼Œå¼‚æ­¥ä»£ç è¿˜æ²¡æœ‰èµ°å®Œï¼Œé‚£ä¹ˆæˆ‘ä»¬æŠŠå¯¹åº”çš„å›è°ƒå…ˆå­˜å…¥å‡†å¤‡å¥½çš„æ•°ç»„ä¸­å³å¯

æœ€é‚£ä¹ˆï¼Œå°±å·®æœ€åä¸€æ­¥æ‰§è¡Œäº†ï¼Œæˆ‘ä»¬åœ¨`resolve`å’Œ`reject`æ–¹æ³•ä¸­è°ƒç”¨å³å¯

```js
function resolve(value) {
  if (_this.state === "pending") {
    _this.value = value
    // éå†æ‰§è¡ŒæˆåŠŸå›è°ƒ
    _this.onResolvedCallbacks.forEach((cb) => cb(value))
    _this.state = "resolved"
  }
}

function reject(reason) {
  if (_this.state === "pending") {
    _this.reason = reason
    // éå†æ‰§è¡Œå¤±è´¥å›è°ƒ
    _this.onRejectedCallbacks.forEach((cb) => cb(reason))
    _this.state = "rejected"
  }
}
```

åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®ç°äº† Promise çš„å¼‚æ­¥è§£å†³ï¼Œèµ¶å¿«æµ‹è¯•ä¸‹

#### å®ç° Promise ç»å…¸çš„é“¾å¼è°ƒç”¨

Promise çš„`then`æ–¹æ³•å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ Promise çš„ç²¾åä¹‹ä¸€ï¼Œåœ¨å®ç°èµ·æ¥ä¹Ÿç®—æ˜¯æ¯”è¾ƒå¤æ‚çš„åœ°æ–¹äº†

é¦–å…ˆæˆ‘ä»¬è¦ç†æ¸…æ¥š`then`çš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Œè¿™éœ€è¦ä»”ç»†çœ‹ Promises/A+è§„èŒƒä¸­å¯¹`then`æ–¹æ³•çš„è¿”å›å€¼å®šä¹‰åŠ Promise è§£å†³è¿‡ç¨‹ï¼Œå½“ç„¶ä½ å¦‚æœä»”ç»†é˜…è¯»äº†ä¸Šæ–‡`then`æ–¹æ³•çš„ä½¿ç”¨å¤§æ¦‚ä¹Ÿæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå†æ¬¡æ€»ç»“ä¸‹

- **é¦–å…ˆ`then` æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª `promise` å¯¹è±¡(åˆ’é‡ç‚¹)**

- **å¦‚æœ`then`æ–¹æ³•ä¸­è¿”å›çš„æ˜¯ä¸€ä¸ªæ™®é€šå€¼(å¦‚ Numberã€String ç­‰)å°±ä½¿ç”¨æ­¤å€¼åŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡è¿”å›**

- **å¦‚æœ`then`æ–¹æ³•ä¸­æ²¡æœ‰`return`è¯­å¥ï¼Œå°±è¿”å›ä¸€ä¸ªç”¨ Undefined åŒ…è£…çš„ Promise å¯¹è±¡**

- **å¦‚æœ`then`æ–¹æ³•ä¸­å‡ºç°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨å¤±è´¥æ€æ–¹æ³•(reject)è·³è½¬åˆ°ä¸‹ä¸€ä¸ª`then`çš„ onRejected**

- **å¦‚æœ`then`æ–¹æ³•æ²¡æœ‰ä¼ å…¥ä»»ä½•å›è°ƒï¼Œåˆ™ç»§ç»­å‘ä¸‹ä¼ é€’(å€¼ç©¿é€)**

- **å¦‚æœ`then`æ–¹æ³•ä¸­è¿”å›äº†ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£å°±ä»¥è¿™ä¸ªå¯¹è±¡ä¸ºå‡†ï¼Œè¿”å›å®ƒçš„ç»“æœ**

å—¯ï¼Œåˆ°æ­¤æˆ‘ä»¬éœ€æ±‚å·²ç»æ˜ç¡®ï¼Œå¼€å§‹ä»£ç å®ç°

éœ€æ±‚ä¸­è¯´å¦‚æœ`then`æ–¹æ³•æ²¡æœ‰ä¼ å…¥ä»»ä½•å›è°ƒï¼Œåˆ™ç»§ç»­å‘ä¸‹ä¼ é€’ï¼Œä½†æ˜¯æ¯ä¸ª`then`ä¸­åˆè¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œä¹Ÿå°±æ˜¯è¯´å½“`then`æ–¹æ³•ä¸­æ²¡æœ‰å›è°ƒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ¥æ”¶åˆ°çš„å€¼ç»§ç»­å‘ä¸‹ä¼ é€’ï¼Œè¿™ä¸ªå…¶å®å¥½åŠï¼Œåªéœ€è¦åœ¨åˆ¤æ–­å›è°ƒå‚æ•°ä¸ä¸ºå‡½æ•°æ—¶æˆ‘ä»¬æŠŠä»–å˜æˆå›è°ƒå‡½æ•°è¿”å›æ™®é€šå€¼å³å¯

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
  onFulfilled =
    typeof onFulfilled === "function" ? onFulfilled : (value) => value
  onRejected =
    typeof onRejected === "function"
      ? onRejected
      : (err) => {
          throw err
        }
  // ...
}
```

æˆ‘ä»¬ä¸Šé¢`then`å®ç°ä¸­ï¼Œåœ¨æ¯ä¸ªå¯æ‰§è¡Œå¤„éƒ½åŠ äº†å‚æ•°æ˜¯å¦ä¸ºå‡½æ•°çš„ç±»å‹æ ¡éªŒï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œåœ¨`then`æ–¹æ³•å¼€å¤´ç»Ÿä¸€åšäº†æ ¡éªŒï¼Œå°±ä¸éœ€è¦å‚æ•°æ ¡éªŒäº†

ç°åœ¨çš„`then`æ–¹æ³•å˜æˆäº†

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
  onFulfilled =
    typeof onFulfilled === "function" ? onFulfilled : (value) => value
  onRejected =
    typeof onRejected === "function"
      ? onRejected
      : (err) => {
          throw err
        }

  if (this.state === "pending") {
    this.onResolvedCallbacks.push(onFulfilled)
    this.onRejectedCallbacks.push(onRejected)
  }

  if (this.state === "resolved") {
    onFulfilled(this.value)
  }
  if (this.state === "rejected") {
    onRejected(this.reason)
  }
}
```

æ¥ç€æ¥

æ—¢ç„¶æ¯ä¸ª`thne`éƒ½åå›ä¸€ä¸ªæ–°çš„ Promiseï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å…ˆåœ¨`then`ä¸­åˆ›å»ºä¸€ä¸ª Promise å®ä¾‹è¿”å›ï¼Œå¼€å§‹æ”¹é€ 

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
  onFulfilled =
    typeof onFulfilled === "function" ? onFulfilled : (value) => value
  onRejected =
    typeof onRejected === "function"
      ? onRejected
      : (err) => {
          throw err
        }

  let promise2 = new Promise((resolve, reject) => {
    if (this.state === "pending") {
      this.onResolvedCallbacks.push(onFulfilled)
      this.onRejectedCallbacks.push(onRejected)
    }

    if (this.state === "resolved") {
      onFulfilled(this.value)
    }
    if (this.state === "rejected") {
      onRejected(this.reason)
    }
  })
  return promise2
}
```

æˆ‘ä»¬åœ¨`then`æ–¹æ³•ä¸­å…ˆå®ä¾‹åŒ–äº†ä¸€ä¸ª Promise å¯¹è±¡å¹¶è¿”å›ï¼Œæˆ‘ä»¬æŠŠåŸæ¥å†™çš„ä»£ç æ”¾åˆ°è¯¥å®ä¾‹çš„å¤„ç†å™¨å‡½æ•°ä¸­

æˆ‘ä»¬æŠŠåŸæ¥å†™çš„ä»£ç æ”¾åˆ°è¯¥å®ä¾‹çš„å¤„ç†å™¨å‡½æ•°ä¸­

æ¥ç€åœ¨æ¯ä¸ªæ‰§è¡Œå‡½æ•°å¤„ä½¿ç”¨`try..catch`è¯­æ³•ï¼Œtry ä¸­`resolve`æ‰§è¡Œç»“æœï¼Œcatch ä¸­`reject`å¼‚å¸¸ï¼ŒåŸæ¥çš„`then`æ–¹æ³•ä¸­æœ‰ resolvedã€rejected å’Œ pending ä¸‰ç§é€»è¾‘åˆ¤æ–­ï¼Œå¦‚ä¸‹

åœ¨ resolved çŠ¶æ€åˆ¤æ–­æ—¶ï¼Œrejected å’Œ resolved é€»è¾‘ä¸€è‡´

```js
if (this.state === "resolved") {
  try {
    // æ‹¿åˆ°è¿”å›å€¼resolveå‡ºå»
    let x = onFulfilled(this.value)
    resolve(x)
  } catch (e) {
    // catchæ•è·å¼‚å¸¸rejectæŠ›å‡º
    reject(e)
  }
}
```

pending çŠ¶æ€åˆ¤æ–­ï¼Œé€»è¾‘ä¹Ÿå’Œ resolved ç›¸ä¼¼ï¼Œä½†æ˜¯ç”±äºæ­¤å¤„ä¸ºäº†å¤„ç†å¼‚æ­¥ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåšäº† push æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ push æ—¶åœ¨ onFulfilled å’Œ onRejected å›è°ƒå¤–é¢å†å¥—ä¸€ä¸ªå›è°ƒåšæ“ä½œå³å¯ï¼Œéƒ½æ˜¯ JS æƒ¯ç”¨å°å¥—è·¯ï¼Œä¸è¿‡åˆ†è§£é‡Š

```js
if (this.state === "pending") {
  // push(onFulfilled)
  // push(()=>{ onFulfilled() })
  // ä¸Šé¢ä¸¤ç§æ‰§è¡Œæ•ˆæœä¸€è‡´ï¼Œåè€…å¯åœ¨å›è°ƒä¸­åŠ ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œå¦‚ä¸‹
  this.onResolvedCallbacks.push(() => {
    try {
      let x = onFulfilled(this.value)
      resolve(x)
    } catch (e) {
      reject(e)
    }
  })
  this.onRejectedCallbacks.push(() => {
    try {
      let x = onRejected(this.value)
      resolve(x)
    } catch (e) {
      reject(e)
    }
  })
}
```

å†æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å¤„ç†æ ¹æ®ä¸Šä¸€ä¸ª`then`æ–¹æ³•çš„è¿”å›å€¼æ¥ç”Ÿæˆæ–° Promise å¯¹è±¡ï¼Œè¿™å—é€»è¾‘å¤æ‚äº›ï¼Œè§„èŒƒä¸­å¯ä»¥æŠ½ç¦»å‡ºä¸€ä¸ªæ–¹æ³•æ¥åšè¿™ä»¶äº‹ï¼Œæˆ‘ä»¬æ¥ç…§åš

```js
/**
 * è§£æthenè¿”å›å€¼ä¸æ–°Promiseå¯¹è±¡
 * @param {Object} æ–°çš„Promiseå¯¹è±¡ï¼Œå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„promise2å®ä¾‹
 * @param {*} x ä¸Šä¸€ä¸ªthençš„è¿”å›å€¼
 * @param {Function} resolve promise2å¤„ç†å™¨å‡½æ•°çš„resolve
 * @param {Function} reject promise2å¤„ç†å™¨å‡½æ•°çš„reject
 */
function resolvePromise(promise2, x, resolve, reject) {
  // ...
}
```

æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥åˆ†æå®Œå–„ resolvePromise å‡½æ•°

**é¿å…å¾ªç¯å¼•ç”¨ï¼Œå½“ then çš„è¿”å›å€¼ä¸æ–°ç”Ÿæˆçš„ Promise å¯¹è±¡ä¸ºåŒä¸€ä¸ª(å¼•ç”¨åœ°å€ç›¸åŒ)ï¼Œåˆ™æŠ›å‡º TypeError é”™è¯¯**

ä¾‹ï¼š

```js
let promise2 = p.then((data) => {
  return promise2
})

// TypeError: Chaining cycle detected for promise #<Promise>
```

å¦‚æœè¿”å›äº†è‡ªå·±çš„ Promise å¯¹è±¡ï¼ŒçŠ¶æ€æ°¸è¿œä¸ºç­‰å¾…æ€(pending)ï¼Œå†ä¹Ÿæ— æ³•æˆä¸º resolved æˆ–æ˜¯ rejectedï¼Œç¨‹åºå°±æ­»æ‰äº†ï¼Œå› æ­¤è¦å…ˆå¤„ç†å®ƒ

```js
function resolvePromise(promise2, x, resolve, reject) {
  if (promise2 === x) {
    reject(new TypeError("è¯·é¿å…Promiseå¾ªç¯å¼•ç”¨"))
  }
}
```

**åˆ¤æ–­ x ç±»å‹ï¼Œåˆ†æƒ…å†µå¤„ç†**

å½“ x æ˜¯ä¸€ä¸ª Promiseï¼Œå°±æ‰§è¡Œå®ƒï¼ŒæˆåŠŸå³æˆåŠŸï¼Œå¤±è´¥å³å¤±è´¥ï¼Œå¦‚æœ`x`æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–æ˜¯å‡½æ•°ï¼Œå†è¿›ä¸€æ­¥å¤„ç†å®ƒï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªæ™®é€šå€¼

```js
function resolvePromise(promise2, x, resolve, reject) {
  if (promise2 === x) {
    reject(new TypeError("è¯·é¿å…Promiseå¾ªç¯å¼•ç”¨"))
  }

  if (x !== null && (typeof x === "object" || typeof x === "function")) {
    // å¯èƒ½æ˜¯ä¸ªå¯¹è±¡æˆ–æ˜¯å‡½æ•°
  } else {
    // æ˜¯ä¸ªæ™®é€šå€¼
    resolve(x)
  }
}
```

å¦‚æœ x æ˜¯ä¸ªå¯¹è±¡ï¼Œå°è¯•å°†å¯¹è±¡ä¸Šçš„ then æ–¹æ³•å–å‡ºæ¥ï¼Œæ­¤æ—¶å¦‚æœæŠ¥é”™ï¼Œé‚£å°±å°† promise2 è½¬ä¸ºå¤±è´¥æ€

åœ¨è¿™é‡Œ catch é˜²æ­¢æŠ¥é”™æ˜¯å› ä¸º Promise æœ‰å¾ˆå¤šå®ç°ï¼Œå‡è®¾å¦ä¸€ä¸ªäººå®ç°çš„ Promise å¯¹è±¡ä½¿ç”¨`Object.defineProperty()`åœ¨å–å€¼æ—¶æŠ›é”™ï¼Œæˆ‘ä»¬å¯ä»¥é˜²æ­¢ä»£ç å‡ºç° bug

```js
// resolvePromiseæ–¹æ³•å†…éƒ¨ç‰‡æ®µ

if (x !== null && (typeof x === "object" || typeof x === "function")) {
  // å¯èƒ½æ˜¯ä¸ªå¯¹è±¡æˆ–æ˜¯å‡½æ•°
  try {
    // å°è¯•å–å‡ºthenæ–¹æ³•å¼•ç”¨
    let then = x.then
  } catch (e) {
    reject(e)
  }
} else {
  // æ˜¯ä¸ªæ™®é€šå€¼
  resolve(x)
}
```

å¦‚æœå¯¹è±¡ä¸­æœ‰`then`ï¼Œä¸”`then`æ˜¯å‡½æ•°ç±»å‹ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œä¹‹åï¼Œä½¿ç”¨`x`ä½œä¸ºå…¶ this æ¥è°ƒç”¨æ‰§è¡Œ`then`æ–¹æ³•

```js
// resolvePromiseæ–¹æ³•å†…éƒ¨ç‰‡æ®µ

if (x !== null && (typeof x === "object" || typeof x === "function")) {
  // å¯èƒ½æ˜¯ä¸ªå¯¹è±¡æˆ–æ˜¯å‡½æ•°
  try {
    // å°è¯•å–å‡ºthenæ–¹æ³•å¼•ç”¨
    let then = x.then
    if (typeof then === "function") {
      // thenæ˜¯functionï¼Œé‚£ä¹ˆæ‰§è¡ŒPromise
      then.call(
        x,
        (y) => {
          resolve(y)
        },
        (r) => {
          reject(r)
        }
      )
    } else {
      resolve(x)
    }
  } catch (e) {
    reject(e)
  }
} else {
  // æ˜¯ä¸ªæ™®é€šå€¼
  resolve(x)
}
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘åˆ°ä¸€ç§æƒ…å†µï¼Œå¦‚æœ Promise å¯¹è±¡è½¬ä¸ºæˆåŠŸæ€æˆ–æ˜¯å¤±è´¥æ—¶ä¼ å…¥çš„è¿˜æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ­¤æ—¶åº”è¯¥ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°æœ€åçš„ Promise æ‰§è¡Œå®Œï¼Œä¾‹å¦‚ä¸‹é¢è¿™ç§

```js
Promise.resolve(1).then((data) => {
  return new Promise((resolve, reject) => {
    // resolveä¼ å…¥çš„è¿˜æ˜¯Promise
    resolve(
      new Promise((resolve, reject) => {
        resolve(2)
      })
    )
  })
})
```

è§£å†³è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€’å½’ï¼ŒæŠŠè°ƒç”¨ resolve æ”¹å†™æˆé€’å½’æ‰§è¡Œ resolvePromiseï¼Œè¿™æ ·ç›´åˆ°è§£æ Promise æˆä¸€ä¸ªæ™®é€šå€¼æ‰ä¼šç»ˆæ­¢

```js
// resolvePromiseæ–¹æ³•å†…éƒ¨ç‰‡æ®µ
if (x !== null && (typeof x === "object" || typeof x === "function")) {
  // å¯èƒ½æ˜¯ä¸ªå¯¹è±¡æˆ–æ˜¯å‡½æ•°
  try {
    let then = x.then
    if (typeof then === "function") {
      then.call(
        x,
        (y) => {
          // é€’å½’è°ƒç”¨ï¼Œä¼ å…¥yè‹¥æ˜¯Promiseå¯¹è±¡ï¼Œç»§ç»­å¾ªç¯
          resolvePromise(promise2, y, resolve, reject)
        },
        (r) => {
          reject(r)
        }
      )
    } else {
      resolve(x)
    }
  } catch (e) {
    reject(e)
  }
} else {
  // æ™®é€šå€¼ç»“æŸé€’å½’
  resolve(x)
}
```

è§„èŒƒä¸­å®šä¹‰ï¼Œå¦‚æœ resolvePromise å’Œ rejectPromise éƒ½è¢«è°ƒç”¨ï¼Œæˆ–è€…å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨ä¼˜å…ˆï¼Œä»»ä½•è¿›ä¸€æ­¥çš„è°ƒç”¨éƒ½å°†è¢«å¿½ç•¥ï¼Œä¸ºäº†è®©æˆåŠŸå’Œå¤±è´¥åªèƒ½è°ƒç”¨ä¸€ä¸ªï¼Œæˆ‘ä»¬æ¥ç€å®Œå–„ï¼Œè®¾å®šä¸€ä¸ª called æ¥é˜²æ­¢å¤šæ¬¡è°ƒç”¨

```js
// resolvePromiseæ–¹æ³•å†…éƒ¨ç‰‡æ®µ
let called
if (x !== null && (typeof x === "object" || typeof x === "function")) {
  // å¯èƒ½æ˜¯ä¸ªå¯¹è±¡æˆ–æ˜¯å‡½æ•°
  try {
    let then = x.then
    if (typeof then === "function") {
      then.call(
        x,
        (y) => {
          if (called) return
          called = true
          // é€’å½’è°ƒç”¨ï¼Œä¼ å…¥yè‹¥æ˜¯Promiseå¯¹è±¡ï¼Œç»§ç»­å¾ªç¯
          resolvePromise(promise2, y, resolve, reject)
        },
        (r) => {
          if (called) return
          called = true
          reject(r)
        }
      )
    } else {
      resolve(x)
    }
  } catch (e) {
    if (called) return
    called = true
    reject(e)
  }
} else {
  // æ™®é€šå€¼ç»“æŸé€’å½’
  resolve(x)
}
```

åˆ°æ­¤ï¼Œæˆ‘ä»¬ç®—æ˜¯å®ç°å¥½äº†`resolvePromise`æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥è°ƒç”¨å®ƒå®ç°å®Œæ•´çš„`then`æ–¹æ³•ï¼Œåœ¨åŸæ¥çš„åŸå‹æ–¹æ³•`then`ä¸­æˆ‘ä»¬`return`äº†ä¸€ä¸ª promise2ï¼Œè¿™ä¸ªå®ä¾‹å¤„ç†å™¨å‡½æ•°çš„ä¸‰ç§çŠ¶æ€åˆ¤æ–­ä¸­æŠŠ`resolve`å¤„æ›¿æ¢æˆ`resolvePromise`æ–¹æ³•å³å¯

é‚£ä¹ˆï¼Œæ­¤æ—¶`then`æ–¹æ³•å®ç°å®Œæˆäº†å—ï¼Ÿ

å½“ç„¶è¿˜æ²¡æœ‰ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒPromise ä¸­å¤„ç†å™¨å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œï¼Œè€Œ`then`æ–¹æ³•æ˜¯å¼‚æ­¥ï¼Œä½†æ˜¯æˆ‘ä»¬å®Œæˆè¿™ä¸ªè¿˜æ˜¯åŒæ­¥

è§£å†³è¿™ä¸ªé—®é¢˜å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä»¿ç…§å¸‚é¢ä¸Šå¤§å¤šæ•° Promise åº“çš„åšæ³•ï¼Œä½¿ç”¨ setTimeout æ¨¡æ‹Ÿï¼Œæˆ‘ä»¬åœ¨`then`æ–¹æ³•å†…æ‰§è¡Œå¤„çš„æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ setTimeout å˜ä¸ºå¼‚æ­¥å³å¯(åªæ˜¯è¿™æ ·åšå’Œæµè§ˆå™¨è‡ªå¸¦çš„ Promises å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯æµè§ˆå™¨çš„ Promise..then æ˜¯å¾®ä»»åŠ¡ï¼Œæˆ‘ä»¬ç”¨ setTimeout å®ç°æ˜¯å®ä»»åŠ¡)ï¼Œä¸è¿‡è¿™ä¹Ÿæ˜¯å¤§å¤šæ•° Promise åº“çš„åšæ³•ï¼Œå¦‚ä¸‹

```js
setTimeout(() => {
  try {
    let x = onFulfilled(value)
    resolvePromise(promise2, x, resolve, reject)
  } catch (e) {
    reject(e)
  }
}, 0)
```

ç°åœ¨æˆ‘ä»¬çš„ç»ˆæç‰ˆ`then`æ–¹æ³•å°±å¤§åŠŸå‘Šæˆäº†

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
  onFulfilled =
    typeof onFulfilled === "function" ? onFulfilled : (value) => value
  onRejected =
    typeof onRejected === "function"
      ? onRejected
      : (err) => {
          throw err
        }

  let promise2 = new Promise((resolve, reject) => {
    // ç­‰å¾…æ€åˆ¤æ–­ï¼Œæ­¤æ—¶å¼‚æ­¥ä»£ç è¿˜æœªèµ°å®Œï¼Œå›è°ƒå…¥æ•°ç»„é˜Ÿåˆ—
    if (this.state === "pending") {
      this.onResolvedCallbacks.push(() => {
        setTimeout(() => {
          try {
            let x = onFulfilled(this.value)
            resolvePromise(promise2, x, resolve, reject)
          } catch (e) {
            reject(e)
          }
        }, 0)
      })

      this.onRejectedCallbacks.push(() => {
        setTimeout(() => {
          try {
            let x = onRejected(this.value)
            resolvePromise(promise2, x, resolve, reject)
          } catch (e) {
            reject(e)
          }
        }, 0)
      })
    }
    if (this.state === "resolved") {
      setTimeout(() => {
        try {
          let x = onFulfilled(this.value)
          resolvePromise(promise2, x, resolve, reject)
        } catch (e) {
          reject(e)
        }
      }, 0)
    }
    if (this.state === "rejected") {
      setTimeout(() => {
        try {
          let x = onRejected(this.reason)
          resolvePromise(promise2, x, resolve, reject)
        } catch (e) {
          reject(e)
        }
      }, 0)
    }
  })
  return promise2
}
```

#### catch å®ç°

å®ç°äº†æœ€å¤æ‚çš„`then`æ–¹æ³•åï¼Œ`catch`å®ç°éå¸¸ç®€å•ï¼Œä¸€çœ‹å°±æ‡‚äº†

```js
Promise.prototype.catch = function (onRejected) {
  return this.then(null, onRejected)
}
```

#### ä»£ç æµ‹è¯•

å¼€æºç¤¾åŒºæä¾›äº†ä¸€ä¸ªåŒ…ç”¨äºæµ‹è¯•æˆ‘ä»¬çš„ä»£ç æ˜¯å¦ç¬¦åˆ Promises/A+è§„èŒƒï¼š`promises-aplus-tests`

é¦–å…ˆæˆ‘ä»¬è¦ä¸ºè¯¥æµ‹è¯•åŒ…æä¾›ä¸€ä¸ª`deferred`é’©å­ï¼Œç”¨äºæµ‹è¯•

å¦‚ä¸‹ï¼Œå°†ä¸‹é¢ä»£ç é˜²æ­¢æˆ‘ä»¬çš„`Promise.js`æ–‡ä»¶æœ«å°¾å³å¯

```js
// promises-aplus-testsæµ‹è¯•
Promise.defer = Promise.deferred = function () {
  let defer = {}
  defer.promise = new Promise((resolve, reject) => {
    defer.resolve = resolve
    defer.reject = reject
  })
  return defer
}
try {
  module.exports = Promise
} catch (e) {}
```

æ¥ç€ï¼Œå®‰è£…è¿™ä¸ªåŒ…

```js
npm install promises-aplus-tests -D
```

æ‰§è¡Œæµ‹è¯•

```js
npx promises-aplus-tests Promise.js
```

é™ç­‰ç‰‡åˆ»ï¼Œå¦‚æœæ§åˆ¶å°æ²¡æœ‰çˆ†çº¢å°±æ˜¯æˆåŠŸäº†ï¼Œç¬¦åˆè§„èŒƒï¼Œå¦‚å›¾æ‰€ç¤º

![image-20200206222942803](https://gitee.com/IsboyJC/PictureBed/raw/master/other/image-20200206222942803.png)

#### å®Œæ•´ä»£ç 

ç¯‡å¹…å·²ç»å¾ˆé•¿äº†ï¼Œåç»­è¿˜æœ‰å…¶ä»–å†…å®¹ï¼Œæ‰€ä»¥å°±å®ç°äº†æ¯”è¾ƒæ ¸å¿ƒçš„ Promise åŠ then å’Œ catch æ–¹æ³•

å…¶ä»–çš„ resolve/reject/race/all ç­‰æ¯”è¾ƒç®€å•ï¼Œä¸åœ¨è¿™é‡Œæè¿°äº†

ç»™å¤§å®¶è´´ä¸ªæˆ‘è¿™è¾¹ Promise å¤šä¸ªæ–¹æ³•å®ç°çš„åœ°å€ï¼Œå¤§å®¶æœ‰å…´è¶£è‡ªè¡Œçœ‹ä»£ç å§ï¼Œæ³¨é‡Šå†™çš„å¾ˆè¯¦ç»†äº†ï¼Œä¹Ÿå°±å¤§æ¦‚ 200 å¤šè¡Œä»£ç 

- Githubï¼šhttps://github.com/isboyjc/promise

### Promise ä¼˜/ç¼º

**ä¼˜ç‚¹**

Promise ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥çš„ä»£ç ï¼Œé¿å…äº†å±‚å±‚åµŒå¥—çš„å›è°ƒå‡½æ•°

Promise å¯¹è±¡æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—æ§åˆ¶å¼‚æ­¥æ“ä½œæ›´åŠ å®¹æ˜“

é“¾å¼æ“ä½œï¼Œå¯ä»¥åœ¨ then ä¸­ç»§ç»­å†™ Promise å¯¹è±¡å¹¶è¿”å›ï¼Œç„¶åç»§ç»­è°ƒç”¨ then æ¥è¿›è¡Œå›è°ƒæ“ä½œ

**ç¼ºç‚¹**

Promise å¯¹è±¡ä¸€æ—¦æ–°å»ºå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•ä¸­é€”å–æ¶ˆ

è‹¥ä¸è®¾ç½®å›è°ƒå‡½æ•°ï¼ŒPromise å†…éƒ¨ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä¸ä¼šæµåˆ°å¤–éƒ¨

å½“å¤„äº pending çŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥å½“å‰å¤„äºå“ªä¸€é˜¶æ®µ

ç”¨å¤šäº† Promise åä»£ç ä¸€çœ¼çœ‹ä¸Šå»éƒ½æ˜¯ promise çš„ APIï¼Œè€Œä¸”é“¾å¼è¯­æ³•æ€»è§‰å¾—ä¸å¥½çœ‹ï¼Œä¸ä¼˜é›…

## Generator

Generator æ˜¯åç¨‹åœ¨ ES6 çš„å®ç°ï¼Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒ

æˆ‘ä»¬å¯ä»¥é€šè¿‡ yield å…³é”®å­—ï¼ŒæŠŠå‡½æ•°çš„æ‰§è¡ŒæµæŒ‚èµ·ï¼Œä¸ºæ”¹å˜æ‰§è¡Œæµç¨‹æä¾›äº†å¯èƒ½ï¼Œä»è€Œä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›è§£å†³æ–¹æ¡ˆ

Generator çš„è‹±æ–‡æ˜¯ç”Ÿæˆå™¨

æƒ³è¦äº†è§£ç”Ÿæˆå™¨(Generator)ï¼Œè¿˜æ˜¯ç»•ä¸è¿‡è¿­ä»£å™¨(Iterator)è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•ä»‹ç»ä¸‹

### è¿­ä»£å™¨(Iterator)

#### Iterator ç®€ä»‹

è¿­ä»£å™¨æ˜¯ä¸€ç§æ¥å£ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§è§„èŒƒ

js ä¸­ä¸åŒçš„æ•°æ®ç±»å‹å¦‚(Array/Object/Set)ç­‰ç­‰éå†æ–¹å¼éƒ½å„æœ‰ä¸åŒï¼Œæ¯”å¦‚å¯¹è±¡éå†æˆ‘ä»¬ä¼šä½¿ç”¨`for..in..`ï¼Œæ•°ç»„å¯ä»¥ä½¿ç”¨`forå¾ªç¯/for..in../forEach`ç­‰ç­‰

é‚£ä¹ˆæœ‰æ²¡æœ‰ç»Ÿä¸€çš„æ–¹å¼éå†è¿™äº›æ•°æ®å‘¢ï¼Ÿè¿™å°±æ˜¯è¿­ä»£å™¨å­˜åœ¨çš„æ„ä¹‰ï¼Œå®ƒå¯ä»¥æä¾›ç»Ÿä¸€çš„éå†æ•°æ®çš„æ–¹å¼ï¼Œåªè¦åœ¨æƒ³è¦éå†çš„æ•°æ®ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ªæ”¯æŒè¿­ä»£å™¨çš„å±æ€§å³å¯

#### Iterator è¯­æ³•

```js
const obj = {
  [Symbol.iterator]: function () {},
}
```

`[Symbol.iterator]` å±æ€§åæ˜¯å›ºå®šçš„å†™æ³•ï¼Œåªè¦æ‹¥æœ‰äº†è¯¥å±æ€§çš„å¯¹è±¡ï¼Œå°±èƒ½å¤Ÿç”¨è¿­ä»£å™¨çš„æ–¹å¼è¿›è¡Œéå†

è¿­ä»£å™¨çš„éå†æ–¹æ³•æ˜¯é¦–å…ˆè·å¾—ä¸€ä¸ªè¿­ä»£å™¨çš„æŒ‡é’ˆï¼Œåˆå§‹æ—¶è¯¥æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€æ¡æ•°æ®ä¹‹å‰

æ¥ç€é€šè¿‡è°ƒç”¨ `next` æ–¹æ³•ï¼Œæ”¹å˜æŒ‡é’ˆçš„æŒ‡å‘ï¼Œè®©å…¶æŒ‡å‘ä¸‹ä¸€æ¡æ•°æ®

æ¯ä¸€æ¬¡çš„ `next` éƒ½ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æœ‰ä¸¤ä¸ªå±æ€§

- value ä»£è¡¨æƒ³è¦è·å–çš„æ•°æ®

- done å¸ƒå°”å€¼ï¼Œfalse è¡¨ç¤ºå½“å‰æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æœ‰å€¼ï¼Œtrue è¡¨ç¤ºéå†å·²ç»ç»“æŸ

#### Iterator è¯¦è§£

åœ¨ JS ä¸­ï¼Œ`Array/Set/Map/String`éƒ½é»˜è®¤æ”¯æŒè¿­ä»£å™¨

ç”±äºæ•°ç»„å’Œé›†åˆéƒ½æ”¯æŒè¿­ä»£å™¨ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½å¯ä»¥ç”¨åŒä¸€ç§æ–¹å¼æ¥éå†

es6 ä¸­æä¾›äº†ä¸€ç§æ–°çš„å¾ªç¯æ–¹æ³•å«åš`for-of`ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨è¿­ä»£å™¨æ¥è¿›è¡Œéå†

æ¢å¥è¯è¯´åªæœ‰æ”¯æŒäº†è¿­ä»£å™¨çš„æ•°æ®ç»“æ„æ‰èƒ½ä½¿ç”¨`for-of`å¾ªç¯

**æ•°ç»„ä¸­ä½¿ç”¨è¿­ä»£å™¨éå†**

```js
let arr = [{ num: 1 }, 2, 3]
let it = arr[Symbol.iterator]() // è·å–æ•°ç»„ä¸­çš„è¿­ä»£å™¨
console.log(it.next()) // { value: Object { num: 1 }, done: false }
console.log(it.next()) // { value: 2, done: false }
console.log(it.next()) // { value: 3, done: false }
console.log(it.next()) // { value: undefined, done: true }
```

æ•°ç»„æ˜¯æ”¯æŒè¿­ä»£å™¨éå†çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è·å–å…¶è¿­ä»£å™¨ï¼Œé›†åˆä¹Ÿæ˜¯ä¸€æ ·

**é›†åˆä¸­ä½¿ç”¨è¿­ä»£å™¨éå†**

```js
let list = new Set([1, 3, 2, 3])
let it = list.entries() // è·å–seté›†åˆä¸­è‡ªå¸¦çš„çš„è¿­ä»£å™¨
console.log(it.next()) // { value: [ 1, 1 ], done: false }
console.log(it.next()) // { value: [ 3, 3 ], done: false }
console.log(it.next()) // { value: [ 2, 2 ], done: false }
console.log(it.next()) // { value: undefined, done: true }
```

é›†åˆä¸æ•°ç»„ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Set ä¸­çš„`entries`æ–¹æ³•è·å–è¿­ä»£å™¨

Set é›†åˆä¸­æ¯æ¬¡éå†å‡ºæ¥çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„ç¬¬ä¸€å’Œç¬¬äºŒä¸ªå…ƒç´ éƒ½æ˜¯ä¸€æ ·çš„

**è‡ªå®šä¹‰å¯¹è±¡ä¸­ä½¿ç”¨è¿­ä»£å™¨éå†**

é¦–å…ˆè‡ªå®šä¹‰çš„å¯¹è±¡æ²¡æœ‰è¿­ä»£å™¨å±æ€§ï¼Œæ‰€ä»¥ä¸æ”¯æŒè¿­ä»£å™¨è¿­ä»£ï¼Œæˆ‘ä»¬ä¹Ÿéƒ½çŸ¥é“`for..of`æ˜¯æ— æ³•éå†å¯¹è±¡çš„ï¼ŒåŸå› å°±åœ¨è¿™é‡Œï¼Œå› ä¸º`for..of`æ˜¯ä½¿ç”¨è¿­ä»£å™¨è¿­ä»£ï¼Œæ‰€ä»¥å¯¹è±¡ä¸èƒ½ç”¨`for..of`

æ—¢ç„¶çŸ¥é“æ˜¯å› ä¸ºè‡ªå®šä¹‰å¯¹è±¡æ— è¿­ä»£å™¨å±æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸ºå®ƒåŠ ä¸Š`Symbol.iterator`è¿™æ ·ä¸€ä¸ªå±æ€§ï¼Œå¹¶ä¸ºå®ƒå®ç°ä¸€ä¸ªè¿­ä»£å™¨æ–¹æ³•ï¼Œå¦‚ä¸‹

```js
let obj = {
  name: "tom",
  age: 18,
  gender: "ç”·",
  intro: function () {
    console.log("my name is " + this.name)
  },
  [Symbol.iterator]: function () {
    let i = 0
    // è·å–å½“å‰å¯¹è±¡çš„æ‰€æœ‰å±æ€§å¹¶å½¢æˆä¸€ä¸ªæ•°ç»„
    let keys = Object.keys(this)
    return {
      next: function () {
        return {
          // å¤–éƒ¨æ¯æ¬¡æ‰§è¡Œnextéƒ½èƒ½å¾—åˆ°æ•°ç»„ä¸­çš„ç¬¬iä¸ªå…ƒç´ 
          value: keys[i++],
          // å¦‚æœæ•°ç»„çš„æ•°æ®å·²ç»éå†å®Œåˆ™è¿”å›true
          done: i > keys.length,
        }
      },
    }
  },
}

for (let attr of obj) {
  console.log(attr)
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼ŒåŠ ä¸Š`[Symbol.iterator]`è¿™ä¸ªè¿­ä»£å™¨å±æ€§æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ªè¿­ä»£å™¨æ–¹æ³•ï¼Œå°±å¯ä»¥ä½¿ç”¨`for..of`æ–¹æ³•äº†

#### Iterator ä½œç”¨

Iterator çš„ä½œç”¨æœ‰ä¸‰ä¸ªï¼š

- ä¸ºå„ç§æ•°æ®ç»“æ„ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„ã€ç®€ä¾¿çš„è®¿é—®æ¥å£
- ä½¿å¾—æ•°æ®ç»“æ„çš„æˆå‘˜èƒ½å¤ŸæŒ‰æŸç§æ¬¡åºæ’åˆ—
- ES6 åˆ›é€ äº†ä¸€ç§æ–°çš„éå†å‘½ä»¤`for..of`å¾ªç¯ï¼ŒIterator æ¥å£ä¸»è¦ä¾›`for..of`æ¶ˆè´¹

Iterator æˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œåˆ°è¿™å°±ç†è§£ä¸Šæ–‡ Iterator å‚æ•°æ˜¯ä»€ä¹ˆäº†å§ï¼Œå°±æ˜¯ä»£è¡¨ä¸€ä¸ªæœ‰è¿­ä»£å™¨å±æ€§çš„å‚æ•°

### åˆè¯† Generator

Generator å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°

æ™®é€šå‡½æ•°ï¼Œä½ è¿è¡Œäº†è¿™ä¸ªå‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨ä¸ä¼šåœï¼Œç›´åˆ°è¿™ä¸ªå‡½æ•°ç»“æŸ

Generator è¿™ä¸ªå‡½æ•°ç‰¹æ®Šä¹‹å¤„å°±æ˜¯ï¼Œä¸­é—´å¯ä»¥åœ

#### Generator å‡½æ•°ç‰¹ç‚¹

```js
function* generatorFn() {
  console.log("a")
  yield "1"
  console.log("b")
  yield "2"
  console.log("c")
  return "3"
}

let it = generatorFn()
it.next()
it.next()
it.next()
it.next()
```

ä¸Šé¢è¿™ä¸ªç¤ºä¾‹å°±æ˜¯ä¸€ä¸ª Generator å‡½æ•°ï¼Œé¦–å…ˆæˆ‘ä»¬è§‚å¯Ÿå®ƒçš„ç‰¹ç‚¹ï¼Œä¸€ä¸ªä¸€ä¸ªè¿›è¡Œåˆ†æ

- ä¸åŒäºæ™®é€šå‡½æ•°ï¼ŒGenerator å‡½æ•°åœ¨`function`åé¢ï¼Œå‡½æ•°åä¹‹å‰æœ‰ä¸ª`*`
  - `*`ç”¨æ¥è¡¨ç¤ºå‡½æ•°ä¸º Generator å‡½æ•°
  - å†™æ³•å¾ˆå¤šï¼Œ`function* fn()`ã€`function*fn()`å’Œ`function *fn()`éƒ½å¯ä»¥
- å‡½æ•°å†…éƒ¨æœ‰`yield`å­—æ®µ
  - `yield`ç”¨æ¥å®šä¹‰å‡½æ•°å†…éƒ¨çš„çŠ¶æ€ï¼Œå¹¶è®©å‡ºæ‰§è¡Œæƒ
  - è¿™ä¸ªå…³é”®å­—åªèƒ½å‡ºç°åœ¨ç”Ÿæˆå™¨å‡½æ•°ä½“å†…ï¼Œä½†æ˜¯ç”Ÿæˆå™¨ä¸­ä¹Ÿå¯ä»¥æ²¡æœ‰ yield å…³é”®å­—ï¼Œå‡½æ•°é‡åˆ° yield çš„æ—¶å€™ä¼šæš‚åœï¼Œå¹¶æŠŠ yield åé¢çš„è¡¨è¾¾å¼ç»“æœæŠ›å‡ºå»
- è°ƒç”¨åå…¶å‡½æ•°è¿”å›å€¼ä½¿ç”¨äº†`next`æ–¹æ³•
  - è°ƒç”¨ Generator å‡½æ•°å’Œè°ƒç”¨æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œåœ¨å‡½æ•°ååé¢åŠ ä¸Š()å³å¯
  - Generator å‡½æ•°ä¸ä¼šåƒæ™®é€šå‡½æ•°ä¸€æ ·ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€å¯¹è±¡çš„æŒ‡é’ˆ
  - æ‰€ä»¥è¦è°ƒç”¨è¿­ä»£å™¨å¯¹è±¡ Iterator çš„ `next` æ–¹æ³•ï¼ŒæŒ‡é’ˆå°±ä¼šä»å‡½æ•°å¤´éƒ¨æˆ–è€…ä¸Šä¸€æ¬¡åœä¸‹æ¥çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œ
  - `next` æ–¹æ³•å…¶å®å°±æ˜¯å°†ä»£ç çš„æ§åˆ¶æƒäº¤è¿˜ç»™ç”Ÿæˆå™¨å‡½æ•°

#### åˆ†ææ‰§è¡Œè¿‡ç¨‹

æ¥ç€æˆ‘ä»¬æ¥åˆ†æå®ƒçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œçº¿æ¥çœ‹å®ƒçš„æ‰“å°ç»“æœï¼Œè¿˜æ˜¯ä¸Šé¢é‚£ä¸ªä¾‹å­

```js
let it = generatorFn()
it.next()
// a
// {value: "1", done: false}

it.next()
// b
// {value: "1", done: false}

it.next()
// c
// {value: "1", done: true}

it.next()
// {value: undefined, done: true}
```

é¦–å…ˆï¼ŒGenerator å‡½æ•°æ‰§è¡Œï¼Œè¿”å›äº†ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€å¯¹è±¡çš„æŒ‡é’ˆï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•è¾“å‡º

ç¬¬ä¸€æ¬¡è°ƒç”¨`next`æ–¹æ³•ï¼Œä» Generator å‡½æ•°çš„å¤´éƒ¨å¼€å§‹æ‰§è¡Œï¼Œå…ˆæ˜¯æ‰“å°äº† a ï¼Œæ‰§è¡Œåˆ°`yield`å°±åœä¸‹æ¥ï¼Œå¹¶å°†`yield`åè¾¹è¡¨è¾¾å¼çš„å€¼ '1'ï¼Œä½œä¸ºè¿”å›å¯¹è±¡çš„ value å±æ€§å€¼ï¼Œæ­¤æ—¶å‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œ è¿”å›å¯¹è±¡çš„ done å±æ€§å€¼æ˜¯ false

ç¬¬äºŒæ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼ŒåŒä¸Šæ­¥

ç¬¬ä¸‰æ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œå…ˆæ˜¯æ‰“å°äº† c ï¼Œç„¶åæ‰§è¡Œäº†å‡½æ•°çš„è¿”å›æ“ä½œï¼Œå¹¶å°† return åé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼Œä½œä¸ºè¿”å›å¯¹è±¡çš„ value å±æ€§å€¼ï¼Œæ­¤æ—¶å‡½æ•°å·²ç»ç»“æŸï¼Œæ‰€ä»¥ done å±æ€§å€¼ä¸º true

ç¬¬å››æ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œ æ­¤æ—¶å‡½æ•°å·²ç»æ‰§è¡Œå®Œäº†ï¼Œæ‰€ä»¥è¿”å› value å±æ€§å€¼æ˜¯ undefinedï¼Œdone å±æ€§å€¼æ˜¯ true ï¼Œå¦‚æœæ‰§è¡Œç¬¬ä¸‰æ­¥æ—¶ï¼Œæ²¡æœ‰ return è¯­å¥çš„è¯ï¼Œå°±ç›´æ¥è¿”å› `{value: undefined, done: true}`

ç®€å•çš„ç†è§£ï¼ŒGenerator å‡½æ•°`yield`æ”¾åˆ°å“ªé‡Œå®ƒå°±åœåˆ°å“ªé‡Œï¼Œè°ƒç”¨æ—¶ä½¿ç”¨`next`æ–¹æ³•è¸¹ä¸€æ­¥å°±èµ°ä¸€æ­¥

#### next å‚æ•°ä¼ é€’

`yield`æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œ`next`æ–¹æ³•ç›´æ¥è°ƒç”¨ä¸ä¼ å…¥å‚æ•°çš„æ—¶å€™ï¼Œ`yield` è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯ undefined

å½“ next ä¼ å…¥å‚æ•°çš„æ—¶å€™ï¼Œè¯¥å‚æ•°ä¼šä½œä¸º**ä¸Šä¸€æ­¥**`yield`çš„è¿”å›å€¼

æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹æ¥ç†è§£

```js
function* geFn() {
  cosnole.log("start")
  let a = yield "1"

  console.log(a)
  let b = yield "2"

  console.log(b)
  let c = yield "3"

  console.log(c)
  return 4
}

let it = geFn()
it.next()
// start
// { value:1, done: false }

it1.next()
// undefined   		æœªä¼ å€¼ï¼Œæ‰€ä»¥a=undefined
// { value:2, done: false }

it.next("hahaha")
// hahaha	     		ä¼ å€¼ï¼Œæ‰€ä»¥b=hahaha
// { value:3, done: false }

it.next("omg")
// omg				 		ä¼ å€¼ï¼Œæ‰€ä»¥c=omg
// {value: 4, done: true}
```

ç”±äº `next` æ–¹æ³•çš„å‚æ•°è¡¨ç¤ºä¸Šä¸€ä¸ª `yield` è¯­å¥çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡ä½¿ç”¨ `next` æ–¹æ³•æ—¶ï¼Œä¸èƒ½å¸¦æœ‰å‚æ•°

V8 å¼•æ“ä¼šç›´æ¥å¿½ç•¥ç¬¬ä¸€æ¬¡ä½¿ç”¨ `next` æ–¹æ³•æ—¶çš„å‚æ•°ï¼Œåªæœ‰ä»ç¬¬äºŒæ¬¡ä½¿ç”¨ `next` æ–¹æ³•å¼€å§‹ï¼Œå‚æ•°æ‰æ˜¯æœ‰æ•ˆçš„

æ²¡æœ‰æ¥åˆ°ä¼ å€¼æ—¶ï¼Œ`yield`è¯­å¥çš„è¿”å›å€¼å°±æ˜¯ undefinedï¼Œæ­£å¦‚ä¸Šé¢ç¤ºä¾‹è¾“å‡ºé‚£æ ·

é€šè¿‡ `next` æ–¹æ³•çš„å‚æ•°ï¼Œå°±æœ‰åŠæ³•åœ¨ Generator å‡½æ•°å¼€å§‹è¿è¡Œä¹‹åï¼Œç»§ç»­å‘å‡½æ•°ä½“å†…éƒ¨æ³¨å…¥å€¼ï¼Œè¿™ä»£è¡¨äº†æˆ‘ä»¬å¯ä»¥åœ¨ Generator å‡½æ•°è¿è¡Œçš„ä¸åŒé˜¶æ®µï¼Œä»å¤–éƒ¨å‘å†…éƒ¨æ³¨å…¥ä¸åŒçš„å€¼ï¼Œä»è€Œè°ƒæ•´å‡½æ•°è¡Œä¸º

#### å†æ¬¡ç†è§£ yield

æˆ‘ä»¬å†æ¥çœ‹ä¸€æ®µä»£ç ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£`yield`

```js
function* geFn() {
  console.log("start")
  let a = yield console.log("1")
  console.log(a)
  let b = yield console.log("2")
  console.log(b)
  return console.log("3")
}

let it = geFn()
it.next()
// start
// 1
// {value: 1, done: false}

it.next("æˆ‘æ˜¯a")
// æˆ‘æ˜¯a
// 2
// {value: 2, done: false}

it.next("æˆ‘æ˜¯b")
// æˆ‘æ˜¯b
// 3
// {value: 3, done: true}
```

é€šè¿‡`next`è°ƒç”¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å°±è¾“å‡ºäº†`start & 1` ï¼Œæ„å‘³ç€`yield`åœæ­¢æ—¶ï¼Œåé¢ä»£ç æ˜¯æ‰§è¡Œäº†çš„

![image-20200207234938429](https://gitee.com/IsboyJC/PictureBed/raw/master/other/image-20200207234938429.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœå°†è¯´`yield`æ¯”åšä¸€é“å¢™ï¼Œé‚£ä¹ˆå¢™å³è¾¹å’Œä¸Šé¢æ˜¯ä¸€å—ï¼Œå¢™å·¦è¾¹å’Œä¸‹é¢æ˜¯ä¸€å—ï¼Œè¿™æ ·è¯´åº”è¯¥å¤Ÿç›´ç™½äº†å§

#### for..of éå† Generator

ä¸Šæ–‡æˆ‘ä»¬å°±çŸ¥é“äº†`for...of`å†…éƒ¨å®ç°å°±æ˜¯åœ¨ä½¿ç”¨è¿­ä»£å™¨è¿­ä»£ï¼Œé‚£ä¹ˆ`for...of`å¾ªç¯ç›´æ¥ç”¨åœ¨ Generator éå†å™¨ä¸Šå²‚ä¸æ˜¯å®Œç¾

æ˜¯çš„ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨éå† Generator å‡½æ•°ï¼Œè€Œä¸”æ­¤æ—¶ä¸å†éœ€è¦è°ƒç”¨ next æ–¹æ³•ï¼Œä¸€æ—¦ next æ–¹æ³•çš„è¿”å›å¯¹è±¡çš„ done å±æ€§ä¸º trueï¼Œ`for...of`å¾ªç¯å°±ä¼šä¸­æ­¢ï¼Œä¸”ä¸åŒ…å«è¯¥è¿”å›å¯¹è±¡

```js
function* foo() {
  yield 1
  yield 2
  yield 3
  yield 4
  yield 5
  return 6
}
for (let v of foo()) {
  console.log(v)
}
// 1 2 3 4 5
```

#### yield\* è¡¨è¾¾å¼

åœ¨`yield`å‘½ä»¤åé¢åŠ ä¸Šæ˜Ÿå·ï¼Œè¡¨æ˜å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªéå†å™¨ï¼Œè¿™è¢«ç§°ä¸º`yield*`è¡¨è¾¾å¼

```js
function* foo() {
  yield "foo1"
  yield "foo2"
}
function* bar() {
  yield "bar1"
  yield* foo()
  yield "bar2"
}
for (let val of bar()) {
  console.log(val)
}

// bar1 foo1 foo2 bar2
```

`yield`å‘½ä»¤åé¢å¦‚æœä¸åŠ æ˜Ÿå·ï¼Œè¿”å›çš„æ˜¯æ•´ä¸ªæ•°ç»„ï¼ŒåŠ äº†æ˜Ÿå·å°±è¡¨ç¤ºè¿”å›çš„æ˜¯æ•°ç»„çš„éå†å™¨

```js
function* gen1() {
  yield ["a", "b", "c"]
}
for (let val of gen1()) {
  console.log(a)
}
// ["a", "b", "c"]

// ------------------- ä¸Šä¸‹åˆ†å‰²

function* gen2() {
  yield* ["a", "b", "c"]
}
for (let val of gen2()) {
  console.log(a)
}
// a b c
```

#### Generator ä¸­çš„ return

return æ–¹æ³•è¿”å›ç»™å®šå€¼ï¼Œå¹¶ç»“æŸéå† Generator å‡½æ•°

å½“ return æ— å€¼æ—¶ï¼Œå°±è¿”å› undefinedï¼Œæ¥çœ‹ä¾‹å­

```js
function* foo() {
  yield 1
  yield 2
  yield 3
}

var f = foo()
f.next()
// {value: 1, done: false}

f.return("hahaha")
// ç”±äºè°ƒç”¨äº†returnæ–¹æ³•ï¼Œæ‰€ä»¥éå†å·²ç»“æŸï¼Œdoneå˜true
// {value: "hahaha", done: true}

f.next()
// {value: undefined, done: true}
```

#### Generator é”™è¯¯å¤„ç† throw

`throw`æ–¹æ³•å¯ä»¥å† Generator å‡½æ•°ä½“å¤–é¢æŠ›å‡ºå¼‚å¸¸ï¼Œå†å‡½æ•°ä½“å†…éƒ¨æ•è·ï¼Œå¬ç€æ˜¯å¾ˆå¥½ç†è§£

è¿™é‡Œä¸€ä¸å°å¿ƒè¿˜æ˜¯æŒºå®¹æ˜“å…¥å‘çš„ï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¾‹å­å§

```js
function* foo() {
  try {
    yield "hahaha"
  } catch (err) {
    console.log("inside error: " + err)
  }
}
var f = foo()
try {
  it.throw("this is err")
} catch (err) {
  console.log("out error: " + err)
}
```

ä¸Šé¢ä»£ç ä¼šè¾“å‡ºå“ªä¸ªé”™è¯¯å‘¢ï¼Ÿ

å…¶å®ç­”æ¡ˆå¾ˆç®€å•ï¼Œä¸Šè¿°ä»£ç ä¼šè¾“å‡º`out errorï¼šthis is err`

å› ä¸ºè°ƒç”¨`throw`çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ‰§è¡Œ`next`æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™å†…éƒ¨çš„`try{}catch{}`ä»£ç éƒ½è¿˜æ²¡æ‰§è¡Œï¼Œå› æ­¤åªä¼šè¢«å¤–é¢æ•æ‰

æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è°ƒç”¨`throw`ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ä¸€é`next`ï¼Œè¿™ä¸ªæ—¶å€™å‡½æ•°ä½“å†…éƒ¨å·²ç»æ‰§è¡Œäº†`try{}catch{}`ï¼Œé‚£ä¹ˆæ‰§è¡Œåˆ°`throw`æ—¶ï¼Œå†…å¤–éƒ½æœ‰é”™è¯¯æ•æ‰ï¼Œ**`throw`æ–¹æ³•ä¼šå…ˆè¢«å†…éƒ¨æ•æ‰**ï¼Œä»è€Œæ‰“å°`inside errorï¼šthis is err`

é™¤æ­¤ï¼Œ**`throw`æ–¹æ³•ä¼šé™„å¸¦æ‰§è¡Œä¸‹ä¸€ä¸ª`yield`**ï¼Œæˆ‘ä»¬æ¥çœ‹ç¤ºä¾‹

```js
var foo = function* foo() {
  try {
    yield console.log("1")
    yield console.log("2")
  } catch (e) {
    console.log("inside err")
  }
  yield console.log("3")
  yield console.log("4")
}
var g = foo()
g.next()
g.throw()
g.next()
```

æˆ‘ä»¬æ¥çœ‹ä¸Šè¿°ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹

é¦–å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ª`next`æ–¹æ³•ï¼Œè¿›å…¥`try()catch()`ï¼Œè¾“å‡º 1

æ¥ç€ï¼Œæ‰§è¡Œ`throw`æ–¹æ³•ï¼Œå†…éƒ¨æ•æ‰åˆ°ï¼Œè¾“å‡º`inside err`ï¼Œæ­¤æ—¶`try()catch()`ä»£ç å—å·²ç»æ‰§è¡Œäº†`catch`ï¼Œ`try()catch()`ä»£ç å—å·²ç»ç»“æŸäº†ï¼Œæ‰€ä»¥é™„å¸¦æ‰§è¡Œä¸€ä¸ª`yield`ä¼šç»§ç»­å‘ä¸‹æ‰¾ï¼Œæ‰€ä»¥å†è¾“å‡º 3

æœ€åæ‰§è¡Œ`next`æ–¹æ³•ï¼Œè¾“å‡º 4

æœ€ç»ˆè¾“å‡ºç»“æœä¸º`1 3 4`

### Generator æ‰©å……

åœ¨ Generator å¼€å¤´æœ‰ä¸€å¥è¯ï¼Œä¸çŸ¥é“å¤§å®¶ç†è§£æ²¡æœ‰

- Generator æ˜¯åç¨‹åœ¨ ES6 çš„å®ç°ï¼Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒ

#### ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ

è¿™é‡Œä½¿ç”¨é˜®ä¸€å³°è€å¸ˆçš„æ–‡ç« å‚è€ƒé“¾æ¥ã€8ã€‘ä¸­å¯¹åç¨‹çš„è§£é‡Šå¹¶ç•¥å¸¦ä¿®æ”¹åŠè¡¥å……

è¿›ç¨‹å’Œçº¿ç¨‹å¤§å®¶åº”è¯¥éƒ½æ¸…æ¥šï¼Œé‚£ä¹ˆåç¨‹æ˜¯ä»€ä¹ˆå‘¢

ä¸çŸ¥é“å¤§å®¶çŸ¥ä¸çŸ¥é“ç”¨æˆ·ç©ºé—´çº¿ç¨‹ï¼Œå…¶å®å°±æ˜¯ä¸€ç§ç”±ç¨‹åºå‘˜è‡ªå·±å†™ç¨‹åºæ¥ç®¡ç†ä»–çš„è°ƒåº¦çš„çº¿ç¨‹ï¼Œå¯¹å†…æ ¸æ¥è¯´ä¸å¯è§

åç¨‹(coroutine)ï¼Œå¯ä»¥ç†è§£å°±æ˜¯ä¸€ç§â€œç”¨æˆ·ç©ºé—´çº¿ç¨‹â€ï¼Œä¹Ÿå¯ç†è§£ä¸ºå¤šä¸ªâ€œçº¿ç¨‹â€ç›¸äº’åä½œï¼Œå®Œæˆå¼‚æ­¥ä»»åŠ¡

ç”±äºçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œå› æ­¤ä¹Ÿå¯ä»¥å¾—å‡ºï¼Œåç¨‹æ˜¯åŸºäºçº¿ç¨‹å®ç°çš„ï¼Œä¸è¿‡å®ƒè¦æ¯”çº¿ç¨‹è¦è½»å¾ˆå¤š

åç¨‹ï¼Œæœ‰å‡ ä¸ªç‰¹ç‚¹ï¼š

- ååŒï¼Œå› ä¸ºæ˜¯ç”±ç¨‹åºå‘˜è‡ªå·±å†™çš„è°ƒåº¦ç­–ç•¥ï¼Œå…¶é€šè¿‡åä½œè€Œä¸æ˜¯æŠ¢å æ¥è¿›è¡Œåˆ‡æ¢
- åœ¨ç”¨æˆ·æ€å®Œæˆåˆ›å»ºï¼Œåˆ‡æ¢å’Œé”€æ¯
- ç¼–ç¨‹è§’åº¦ä¸Šçœ‹ï¼Œåç¨‹çš„æ€æƒ³æœ¬è´¨ä¸Šå°±æ˜¯æ§åˆ¶æµçš„ä¸»åŠ¨è®©å‡º(yield)å’Œæ¢å¤(resume)æœºåˆ¶

å®ƒçš„è¿è¡Œæµç¨‹å¦‚ä¸‹

- åç¨‹ A å¼€å§‹æ‰§è¡Œ
- åç¨‹ A æ‰§è¡Œåˆ°ä¸€åŠï¼Œæš‚åœæ‰§è¡Œï¼Œæ‰§è¡Œçš„æƒåˆ©è½¬äº¤ç»™åç¨‹ Bã€‚
- ä¸€æ®µæ—¶é—´å B äº¤è¿˜æ‰§è¡Œæƒ
- åç¨‹ A é‡å¾—æ‰§è¡Œæƒï¼Œç»§ç»­æ‰§è¡Œ

ä¸Šé¢çš„åç¨‹ A å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå› ä¸ºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œæƒè¢« B æŠ¢äº†ï¼Œè¢«è¿«åˆ†æˆä¸¤æ­¥å®Œæˆ

ä¸¾ä¾‹æ¥è¯´ï¼Œè¯»å–æ–‡ä»¶çš„åç¨‹å†™æ³•å¦‚ä¸‹

```javascript
function asnycJob() {
  // ...å…¶ä»–ä»£ç 
  var f = yield readFile(fileA);
  // ...å…¶ä»–ä»£ç 
}
```

ä¸Šé¢ä»£ç çš„å‡½æ•° asyncJob æ˜¯ä¸€ä¸ªåç¨‹ï¼Œå…¶ä¸­çš„ `yield` å‘½ä»¤ï¼Œå®ƒè¡¨ç¤ºæ‰§è¡Œåˆ°æ­¤å¤„ï¼Œæ‰§è¡Œæƒå°†äº¤ç»™å…¶ä»–åç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`yield`å‘½ä»¤æ˜¯å¼‚æ­¥ä¸¤ä¸ªé˜¶æ®µçš„åˆ†ç•Œçº¿

åç¨‹é‡åˆ° `yield` å‘½ä»¤å°±æš‚åœï¼Œç­‰åˆ°æ‰§è¡Œæƒè¿”å›ï¼Œå†ä»æš‚åœçš„åœ°æ–¹ç»§ç»­å¾€åæ‰§è¡Œï¼Œå®ƒçš„æœ€å¤§ä¼˜ç‚¹ï¼Œå°±æ˜¯ä»£ç çš„å†™æ³•éå¸¸åƒåŒæ­¥æ“ä½œï¼Œåªå¤šäº†ä¸€ä¸ª`yield`å‘½ä»¤

#### Generator ä¸åç¨‹

JS æ˜¯å•çº¿ç¨‹çš„ï¼ŒES6 ä¸­çš„ Generator çš„å®ç°ï¼Œç±»ä¼¼äºå¼€äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ä¾ç„¶åŒæ—¶åªèƒ½è¿›è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œä¸è¿‡å¯ä»¥åˆ‡æ¢

å°±åƒæ±½è½¦åœ¨å…¬è·¯ä¸Šè¡Œé©¶ï¼Œjs å…¬è·¯åªæ˜¯å•è¡Œé“(ä¸»çº¿ç¨‹)ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šè½¦é“(è¾…åŠ©çº¿ç¨‹)éƒ½å¯ä»¥æ±‡å…¥è½¦æµ(å¼‚æ­¥ä»»åŠ¡å®Œæˆåå›è°ƒè¿›å…¥ä¸»çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—)

è€Œ Generator æŠŠ js å…¬è·¯å˜æˆäº†å¤šè½¦é“(åç¨‹å®ç°)ï¼Œä½†æ˜¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè½¦é“ä¸Šçš„è½¦èƒ½å¼€(æ‰€ä»¥ä¾ç„¶æ˜¯å•çº¿ç¨‹)ï¼Œä¸è¿‡å¯ä»¥è‡ªç”±å˜é“(ç§»äº¤æ§åˆ¶æƒ)

#### Generator ä¹‹ Thunk å‡½æ•°

thunk å‡½æ•°çš„è¯ç”Ÿæºäºä¸€ä¸ªç¼–è¯‘å™¨è®¾è®¡çš„é—®é¢˜ï¼š`æ±‚å€¼ç­–ç•¥`ï¼Œå³å‡½æ•°çš„å‚æ•°åˆ°åº•åº”è¯¥ä½•æ—¶æ±‚å€¼

```js
var x = 1
function fn(n) {
  return n * 10
}
fn(x + 5)
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œå…¶ä¸­ fn æ–¹æ³•è°ƒç”¨æ—¶`x+5`è¿™ä¸ªè¡¨è¾¾å¼åº”è¯¥ä»€ä¹ˆæ—¶å€™æ±‚å€¼ï¼Œæœ‰ä¸¤ç§æ€è·¯

- **ä¼ å€¼è°ƒç”¨(call by value)**ï¼Œå…ˆè®¡ç®—`x+5`çš„å€¼ï¼Œå†å°†è¿™ä¸ªå€¼ `6` ä¼ å…¥å‡½æ•° fnï¼Œä¾‹å¦‚ c è¯­è¨€ï¼Œè¿™ç§åšæ³•çš„å¥½å¤„æ˜¯å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æœ‰å¯èƒ½ä¼šé€ æˆæ€§èƒ½æŸå¤±(ä¾‹å¦‚ä¸€ä¸ªå‡½æ•°ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä½†æ˜¯å‡½æ•°ä½“å†…æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå…ˆè®¡ç®—å‡ºå€¼å°±ä¼šæŸè€—æ€§èƒ½ä¸”æ— æ„ä¹‰)
- **ä¼ åè°ƒç”¨(call by name)**ï¼Œå³ç›´æ¥å°†è¡¨è¾¾å¼`x+5`ä¼ å…¥å‡½æ•°ä½“ï¼Œåªåœ¨ç”¨åˆ°å®ƒçš„æ—¶å€™æ±‚å€¼

Thunk å‡½æ•°çš„å®šä¹‰ï¼Œå°±æ˜¯ä¼ åè°ƒç”¨çš„ä¸€ç§å®ç°ç­–ç•¥ï¼Œç”¨æ¥æ›¿æ¢æŸä¸ªè¡¨è¾¾å¼ï¼Œå®ç°æ€è·¯å…¶å®ä¹Ÿå¾ˆç®€å•

å…ˆå°†å‚æ•°æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶å‡½æ•°ä¹‹ä¸­ï¼Œå†å°†è¿™ä¸ªä¸´æ—¶å‡½æ•°ä¼ å…¥å‡½æ•°ä½“ï¼Œå°±åƒä¸‹é¢è¿™æ ·

```js
function fn(m) {
  return m * 2
}
fn(x + 5)

// thunkå®ç°æ€è·¯
var thunk = function () {
  return x + 5
}

function fn(thunk) {
  return thunk() * 2
}
```

JS æ˜¯ä¼ å€¼è°ƒç”¨ï¼Œå®ƒçš„ Thunck å‡½æ•°å«ä¹‰æœ‰æ‰€ä¸åŒ

åœ¨ JS ä¸­ï¼ŒThunk å‡½æ•°æ›¿æ¢çš„ä¸æ˜¯è¡¨è¾¾å¼ï¼Œæ˜¯å¯¹å‡½æ•°ç‚é‡ŒåŒ–çš„ä¸€ç§è¿ç”¨ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠæ˜¯å¤šå‚æ•°å‡½æ•°æ›¿æ¢æˆä¸€ä¸ªåªæ¥å—å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°çš„å•å‚æ•°å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„ç®€å•å®ç°

```js
fs.readFile(fileName, callback)

const Thunk = function (fn) {
  return function (...args) {
    return function (callback) {
      return fn.call(this, ...args, callback)
    }
  }
}

// ä½¿ç”¨ä¸Šé¢çš„Thunkè½¬åŒ–å™¨ï¼Œç”Ÿæˆfs.readFileçš„Thunkå‡½æ•°
var readFileThunk = Thunk(fs.readFile)
readFileThunk(fileName)(callback)
```

å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒè¦ä½¿ç”¨ Thunk å‡½æ•°çš„è¯ï¼Œä½¿ç”¨ Thunkify æ¨¡å—å°±å¯ä»¥ï¼Œå…¶å®å®ƒæ ¸å¿ƒæºç å°±æ˜¯ä¸Šé¢æˆ‘ä»¬å†™çš„ Thunkï¼ŒThunkify é‡Œå¤šäº†ä¸€ä¸ªæ£€æŸ¥æœºåˆ¶è€Œå·²ï¼Œæ¯”è¾ƒç®€å•ï¼Œå¯è‡ªè¡Œç™¾åº¦ Thunkify æ¨¡å—äº†è§£

Thunk è¿™ä¸œè¥¿åœ¨ ES6 å‰å…¶å®æ²¡æœ‰å¤ªå¤§ç”¨å¤„ï¼Œä½†æ˜¯åœ¨ Generator å‡½æ•°å‡ºæ¥åï¼ŒThunk å‡½æ•°å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒå¯ä»¥ç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†ï¼Œæ¥æ”¶å’Œäº¤æ¢ç¨‹åºçš„æ‰§è¡Œæƒ

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåŸºäº Thunk å‡½æ•°çš„ Generator è‡ªåŠ¨æ‰§è¡Œå™¨

```js
// åŸºäºThunkå‡½æ•°çš„Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
function run(fn) {
  let gen = fn()
  function next(err, data) {
    // å°†æŒ‡é’ˆç§»åŠ¨åˆ°Generatorå‡½æ•°çš„ä¸‹ä¸€æ­¥
    let result = gen.next(data)
    // åˆ¤æ–­æ˜¯å¦ç»“æŸ
    if (result.done) return
    // é€’å½’,æŠŠnextæ”¾è¿›.valueä¸­
    result.value(next)
  }
  next()
}

// æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•
let sleep = function (n, callback) {
  setTimeout(() => {
    console.log(n)
    callback && callback(n)
  }, n)
}

// æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•è¿›è¡ŒThunkè½¬æ¢
let sleepThunk = Thunk(sleep)

// Generatorå‡½æ•°
let gen = function* () {
  let f1 = yield sleepThunk(1000)
  let f2 = yield sleepThunk(1500)
  // ...
  let fn = yield sleepThunk(2000)
}

// è°ƒç”¨Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
run(gen)
```

ä¸Šé¢ä»£ç çš„ run å‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ª Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ï¼Œå†…éƒ¨çš„ next å‡½æ•°å°±æ˜¯ Thunk çš„å›è°ƒå‡½æ•°

next å‡½æ•°å…ˆå°†æŒ‡é’ˆç§»åˆ° Generator å‡½æ•°çš„ä¸‹ä¸€æ­¥(gen.next æ–¹æ³•)

ç„¶ååˆ¤æ–­ Generator å‡½æ•°æ˜¯å¦ç»“æŸ(result.done å±æ€§)

å¦‚æœæ²¡ç»“æŸï¼Œå°±å°† next å‡½æ•°å†ä¼ å…¥ Thunk å‡½æ•°(result.value å±æ€§)ï¼Œå¦åˆ™å°±ç›´æ¥é€€å‡º

ä»£ç ä¸­æ¨¡æ‹Ÿäº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œ`sleep`æ–¹æ³•ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºäº† Thunk æ–¹æ³•(ä½¿ç”¨ä¸Šæ–‡æˆ‘ä»¬å®ç°çš„é‚£ä¸ªç®€æ˜“ç‰ˆ Thunk)

å‡½æ•° gen å°è£…äº† n ä¸ªå¼‚æ­¥æ“ä½œï¼Œåªè¦æ‰§è¡Œ run å‡½æ•°ï¼Œè¿™äº›æ“ä½œå°±ä¼šè‡ªåŠ¨å®Œæˆ

è¿™æ ·ä¸€æ¥ï¼Œå¼‚æ­¥æ“ä½œä¸ä»…å¯ä»¥å†™å¾—åƒåŒæ­¥æ“ä½œï¼Œè€Œä¸”ä¸€è¡Œä»£ç å°±å¯ä»¥æ‰§è¡Œï¼Œæå…¶æ–¹ä¾¿

ä¸è¿‡ç›¸ä¿¡å¤§å®¶ä¹Ÿçœ‹åˆ°äº†ï¼Œè¿™ç§è‡ªåŠ¨æ‰§è¡Œå™¨ä¼ å…¥çš„ Generator å‡½æ•°ï¼Œ**yield æ–¹æ³•åé¢å¿…é¡»æ˜¯ä¸€ä¸ª Thunk å‡½æ•°**

--------ğŸ‘‡--------

Thunk å°±ç®€å•ä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œæ›´å¤š Thunk ç›¸å…³æ¨èçœ‹é˜®ä¸€å³°æ–‡å‚è€ƒé“¾æ¥ã€9ã€‘

æˆ‘ä»¬åªéœ€è¦æ˜ç™½ Thunk æ˜¯ä»€ä¹ˆï¼Œå®ƒå’Œ Generator æœ‰ä»€ä¹ˆå…³ç³»å°±å¯ä»¥

#### Generator ä¹‹ co å‡½æ•°åº“

co å‡½æ•°åº“æ˜¯è‘—åç¨‹åºå‘˜ TJ Holowaychuk äº 2013 å¹´ 6 æœˆå‘å¸ƒçš„ä¸€ä¸ªå°å·¥å…·ï¼Œç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œ

[co å‡½æ•°åº“ä¼ é€é—¨](https://github.com/tj/co)

co å‡½æ•°åº“å…¶å®å°±æ˜¯å°†ä¸¤ç§è‡ªåŠ¨æ‰§è¡Œå™¨(Thunk å‡½æ•°å’Œ Promise å¯¹è±¡)ï¼ŒåŒ…è£…æˆä¸€ä¸ªåº“ï¼Œæ‰€ä»¥è¯´ä½¿ç”¨ co çš„å‰ææ¡ä»¶æ˜¯ï¼ŒGenerator å‡½æ•°çš„ yield å‘½ä»¤åé¢ï¼Œåªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡

co å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª Promiseï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åæ¥`then`ç­‰æ–¹æ³•

åŸºäº Thunk å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ä¸Šé¢ä»‹ç»äº†ä¸‹ï¼Œé‚£ä¹ˆåŸºäº Promise çš„å…¶å®ä¹Ÿå·®ä¸å¤šï¼Œæˆ‘ä»¬ç®€å•å®ç°ä¸‹

```js
// åŸºäºPromiseå‡½æ•°çš„Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
function run(gen) {
  let g = gen()

  function next(data) {
    // å°†æŒ‡é’ˆç§»åŠ¨åˆ°Generatorå‡½æ•°çš„ä¸‹ä¸€æ­¥
    let result = g.next(data)
    // åˆ¤æ–­æ˜¯å¦ç»“æŸï¼Œç»“æŸè¿”å›valueï¼Œvalueæ˜¯ä¸€ä¸ªPromise
    if (result.done) return result.value
    // é€’å½’
    result.value.then((data) => {
      next(data)
    })
  }
  next()
}

// æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•è¿›è¡ŒPromiseè½¬æ¢
let sleepPromise = function (n) {
  return new Promise(function (resolve, reject) {
    setTimeout(() => {
      console.log(n)
      resolve(n)
    }, n)
  })
}

// Generatorå‡½æ•°
let gen = function* () {
  let f1 = yield sleepPromise(1000)
  let f2 = yield sleepPromise(1500)
  // ...
  let fn = yield sleepPromise(2000)
}

// è°ƒç”¨Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
run(gen)
```

å¦‚ä¸Šä»£ç ï¼Œå’Œ Thunk å‡½æ•°é‚£é‡ŒåŒºåˆ«å°±æ˜¯ yield åé¢ä¸€ä¸ªè·Ÿ Thunk å‡½æ•°ï¼Œä¸€ä¸ªè·Ÿ Promise å¯¹è±¡

å¦‚æœ Thunk è‡ªæ‰§è¡Œå™¨ä½ ç†è§£äº†ï¼ŒPromise ä½¿ç”¨ä¹Ÿ ok çš„è¯ï¼Œè¿™å—ä»£ç çœ‹çœ‹å°±æ‡‚äº†ï¼Œä¹Ÿæ²¡å•¥è§£é‡Šçš„

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ co åº“çš„æºç 

co å‡½æ•°åº“çš„æºç ä¹Ÿå¾ˆç®€å•ï¼Œåªæœ‰å‡ åè¡Œä»£ç 

é¦–å…ˆï¼Œco å‡½æ•°æ¥å— Generator å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡

```js
function co(gen) {
  var ctx = this
  return new Promise(function (resolve, reject) {})
}
```

åœ¨è¿”å›çš„ Promise å¯¹è±¡é‡Œé¢ï¼Œco å…ˆæ£€æŸ¥å‚æ•° gen æ˜¯å¦ä¸º Generator å‡½æ•°

å¦‚æœæ˜¯ï¼Œå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªå†…éƒ¨æŒ‡é’ˆå¯¹è±¡

å¦‚æœä¸æ˜¯å°±è¿”å›ï¼Œå¹¶å°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º resolved

```js
function co(gen) {
  var ctx = this

  return new Promise(function (resolve, reject) {
    if (typeof gen === "function") gen = gen.call(ctx)
    if (!gen || typeof gen.next !== "function") return resolve(gen)
  })
}
```

æ¥ç€ï¼Œco å°† Generator å‡½æ•°çš„å†…éƒ¨æŒ‡é’ˆå¯¹è±¡çš„ next æ–¹æ³•ï¼ŒåŒ…è£…æˆ onFulefilled å‡½æ•°

ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿæ•æ‰æŠ›å‡ºçš„é”™è¯¯

```js
function co(gen) {
  var ctx = this

  return new Promise(function (resolve, reject) {
    if (typeof gen === "function") gen = gen.call(ctx)
    if (!gen || typeof gen.next !== "function") return resolve(gen)

    onFulfilled()
    function onFulfilled(res) {
      var ret
      try {
        ret = gen.next(res)
      } catch (e) {
        return reject(e)
      }
      next(ret)
    }
  })
}
```

æœ€åï¼Œå°±æ˜¯å…³é”®çš„ next å‡½æ•°ï¼Œå®ƒä¼šåå¤è°ƒç”¨è‡ªèº«

```js
function next(ret) {
  if (ret.done) return resolve(ret.value)
  var value = toPromise.call(ctx, ret.value)
  if (value && isPromise(value)) return value.then(onFulfilled, onRejected)
  return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, but the following object was passed: "' + String(ret.value) + '"'))
    }
})
```

`next`æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€è¡Œï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦ä¸º Generator å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œå¦‚æœæ˜¯å°±è¿”å›

ç¬¬äºŒè¡Œï¼Œç¡®ä¿æ¯ä¸€æ­¥çš„è¿”å›å€¼ï¼Œæ˜¯ Promise å¯¹è±¡

ç¬¬ä¸‰è¡Œï¼Œä½¿ç”¨ then æ–¹æ³•ï¼Œä¸ºè¿”å›å€¼åŠ ä¸Šå›è°ƒå‡½æ•°ï¼Œç„¶åé€šè¿‡ onFulfilled å‡½æ•°å†æ¬¡è°ƒç”¨ next å‡½æ•°

ç¬¬å››è¡Œï¼Œåœ¨å‚æ•°ä¸ç¬¦åˆè¦æ±‚çš„æƒ…å†µä¸‹(å‚æ•°é Thunk å‡½æ•°å’Œ Promise å¯¹è±¡)ï¼Œå°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º rejectedï¼Œä»è€Œç»ˆæ­¢æ‰§è¡Œ

co æ”¯æŒå¹¶å‘çš„å¼‚æ­¥æ“ä½œï¼Œå³å…è®¸æŸäº›æ“ä½œåŒæ—¶è¿›è¡Œï¼Œç­‰åˆ°å®ƒä»¬å…¨éƒ¨å®Œæˆï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å¹¶å‘çš„æ“ä½œæ”¾åœ¨æ•°ç»„æˆ–å¯¹è±¡é‡Œé¢ï¼Œå¦‚ä¸‹

```js
// æ•°ç»„çš„å†™æ³•
co(function* () {
  var res = yield [Promise.resolve(1), Promise.resolve(2)]
  console.log(res)
}).catch(onerror)

// å¯¹è±¡çš„å†™æ³•
co(function* () {
  var res = yield {
    1: Promise.resolve(1),
    2: Promise.resolve(2),
  }
  console.log(res)
}).catch(onerror)
```

-------ğŸ‘‡-------

ä»¥ä¸Šå°±æ˜¯ co çš„å†…å®¹äº†ï¼Œè¿™é‡ŒæåŠåªæ˜¯ä¸ºäº†è®©å¤§å®¶äº†è§£ co è¿™ç§å‡½æ•°åº“ï¼Œè™½ç„¶ç›®å‰ç”¨çš„ä¸å¤šï¼Œä½†æ˜¯å¯¹æˆ‘ä»¬ç†è§£ Generator æœ‰å¸®åŠ©ï¼Œå³ä½¿è¿™é‡Œæœ‰äº›è¿·ç³Šï¼Œä¹Ÿæ— ä¼¤å¤§é›…ï¼ŒçŸ¥é“ co æ˜¯ä»€ä¹ˆï¼Œco çš„è‡ªåŠ¨æ‰§è¡ŒåŸç†å¤§æ¦‚æ˜¯æ€ä¹ˆå®ç°çš„å°±è¡Œ

è¿™å—å’Œ Thunk ä¸€æ ·ï¼Œä¹Ÿæ˜¯å‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„æ–‡ç« ï¼Œæ‰€ä»¥æœ‰å…´è¶£çš„è¯å¯ä»¥çœ‹ä¸‹å‚è€ƒé“¾æ¥ã€10ã€‘

### Generator ä¼˜/ç¼º

#### ä¼˜ç‚¹

ä¼˜é›…çš„æµç¨‹æ§åˆ¶æ–¹å¼ï¼Œå¯ä»¥è®©å‡½æ•°å¯ä¸­æ–­æ‰§è¡Œï¼Œåœ¨æŸäº›ç‰¹æ®Šéœ€æ±‚é‡Œè¿˜æ˜¯å¾ˆå®ç”¨çš„

ä½¿ç”¨è¿‡ React-dva çš„åŒå­¦å¯èƒ½ä¼šæ›´æœ‰æ„Ÿè§¦ä¸€äº›

ä¹‹å‰ Node çš„ koa æ¡†æ¶ä¹Ÿç”¨ Generatorï¼Œä¸è¿‡åæ¥è¢« async/await æ›¿ä»£äº†

#### ç¼ºç‚¹

Generator å‡½æ•°çš„æ‰§è¡Œå¿…é¡»é æ‰§è¡Œå™¨ï¼Œæ‰€ä»¥æ‰æœ‰äº† co å‡½æ•°åº“ï¼Œä½† co æ¨¡å—çº¦å®šï¼Œyield å‘½ä»¤åé¢åªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡ï¼Œåªé’ˆå¯¹å¼‚æ­¥å¤„ç†æ¥è¯´ï¼Œè¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿

## Async/Await

### Async å’Œ Await ç®€ä»‹

ES2017 æ ‡å‡†å¼•å…¥äº† `async` å‡½æ•°ï¼Œä½¿å¾—å¼‚æ­¥æ“ä½œå˜å¾—æ›´åŠ æ–¹ä¾¿

JS å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆçš„å†ç¨‹ï¼Œä»ç»å…¸çš„å›è°ƒå‡½æ•°åˆ°äº‹ä»¶ç›‘å¬ï¼Œå†åˆ° `Promise` ï¼Œå†åˆ° `Generator` ï¼Œå†åˆ°æˆ‘ä»¬è¦è¯´çš„ `Async/Await` ï¼Œå¯è°“è‰°è¾›

`Async/Await` çš„å‡ºç°ï¼Œè¢«å¾ˆå¤šäººè®¤ä¸ºæ˜¯ JS å¼‚æ­¥æ“ä½œçš„æœ€ç»ˆä¸”æœ€ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ

`Async/Await` å¤§å®¶éƒ½ç»å¸¸ä½¿ç”¨ï¼Œä¹Ÿéƒ½çŸ¥é“å®ƒæ˜¯ `Generator` çš„è¯­æ³•ç³–

å…¶å®æˆ‘è§‰å¾— `Async/Await = Generator + Promise` è¿™ä¸ªè§£é‡Šæ›´é€‚åˆ

`async` æ˜¯å¼‚æ­¥çš„æ„æ€ï¼Œè€Œ `await` æ˜¯ `async wait` çš„ç®€å†™ï¼Œå³å¼‚æ­¥ç­‰å¾…

æ‰€ä»¥ä»è¯­ä¹‰ä¸Šå°±å¾ˆå¥½ç†è§£ `async` ç”¨äºå£°æ˜ä¸€ä¸ª `function` æ˜¯å¼‚æ­¥çš„ï¼Œ`await` ç”¨äºç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œæˆ

å¦å¤– `await` åªèƒ½å‡ºç°åœ¨ `async` å‡½æ•°ä¸­

é—²èŠè‡³æ­¤ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯ç®€å•ä»‹ç»ä¸‹ä½¿ç”¨

### Async åœ¨åšä»€ä¹ˆ

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ç†è§£

```js
async function test() {
  return "this is async"
}
const res = test()
console.log(res)
// PromiseÂ {<resolved>: "this is async"}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºçš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡

æ‰€ä»¥ï¼Œ`async` å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœåœ¨ `async` å‡½æ•°ä¸­ç›´æ¥ return ä¸€ä¸ªç›´æ¥é‡ï¼Œ`async` ä¼šæŠŠè¿™ä¸ªç›´æ¥é‡é€šè¿‡ `PromIse.resolve()` å°è£…æˆ Promise å¯¹è±¡è¿”å›

æ—¢ç„¶ `async` è¿”å›ä¸€ä¸ª Promiseï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ `then` é“¾æ¥å¤„ç†è¿™ä¸ª Promise å¯¹è±¡ï¼Œå¦‚ä¸‹

```js
test().then((res) => {
  console.log(res)
})
```

### Await åœ¨ç­‰å¾…ä»€ä¹ˆ

æˆ‘ä»¬å¸¸è¯´`await` æ˜¯åœ¨ç­‰å¾…ä¸€ä¸ªå¼‚æ­¥å®Œæˆï¼Œ å…¶å®æŒ‰ç…§è¯­æ³•è¯´æ˜ï¼Œ `await` ç­‰å¾…çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„è®¡ç®—ç»“æœæ˜¯ Promise å¯¹è±¡æˆ–è€…å…¶å®ƒå€¼(æ¢å¥è¯è¯´ï¼Œå°±æ˜¯æ²¡æœ‰ç‰¹æ®Šé™å®šï¼Œå•¥éƒ½è¡Œ)

- `await` åé¢ä¸æ˜¯ Promise å¯¹è±¡ï¼Œç›´æ¥æ‰§è¡Œ
- `await` åé¢æ˜¯ Promise å¯¹è±¡ä¼šé˜»å¡åé¢çš„ä»£ç ï¼ŒPromise å¯¹è±¡ `resolve`ï¼Œç„¶åå¾—åˆ° `resolve` çš„å€¼ï¼Œä½œä¸º `await` è¡¨è¾¾å¼çš„è¿ç®—ç»“æœ
- `await` åªèƒ½åœ¨ `async` å‡½æ•°ä¸­ä½¿ç”¨

ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œå¤§å®¶ä¹Ÿç»å¸¸ç”¨å°±ä¸å¤šè¯´äº†

ç®€å•è¯´ä¸€ä¸‹ä¸ºä»€ `await` å¿…é¡»è¦åœ¨ `async` å‡½æ•°ä¸­ä½¿ç”¨

å…¶å®å¾ˆç®€å•ï¼Œ `await` ä¼šé˜»å¡åé¢ä»£ç ï¼Œå¦‚æœå…è®¸æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `await` çš„è¯ï¼Œå‡å¦‚æˆ‘ä»¬ä½¿ç”¨`await`ç­‰å¾…ä¸€ä¸ªæ¶ˆè€—æ—¶é—´æ¯”è¾ƒé•¿çš„å¼‚æ­¥è¯·æ±‚ï¼Œé‚£ä»£ç ç›´æ¥å°±é˜»å¡ä¸å¾€ä¸‹æ‰§è¡Œäº†ï¼Œåªèƒ½ç­‰å¾… `await` æ‹¿åˆ°ç»“æœæ‰ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œé‚£ä¸ä¹±å¥—äº†

è€Œ `async` å‡½æ•°è°ƒç”¨ä¸ä¼šé€ æˆé˜»å¡ï¼Œå› ä¸ºå®ƒå†…éƒ¨æ‰€æœ‰çš„é˜»å¡éƒ½è¢«å°è£…åœ¨ä¸€ä¸ª Promise å¯¹è±¡ä¸­å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥æ‰è§„å®š `await` å¿…é¡»åœ¨ `async` å‡½æ•°ä¸­

### å¤„ç†å¼‚å¸¸

promise æ­£å¸¸ resolveï¼Œé‚£ä¹ˆ await ä¼šè¿”å›è¿™ä¸ªç»“æœï¼Œä½†æ˜¯åœ¨ reject çš„æƒ…å†µä¸‹ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯

æ‰€ä»¥æˆ‘ä»¬ç›´æ¥æŠŠ `await` ä»£ç å—å†™åˆ° `try()catch()` ä¸­æ•è·é”™è¯¯å³å¯

```js
async function fn() {
  try {
    let res = await ajax()
    console.log(res)
  } catch (err) {
    console.log(err)
  }
}
```

### æ²¡æœ‰å¯¹æ¯”æ²¡æœ‰ä¼¤å®³

æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™ç§ä¸šåŠ¡ï¼Œå¤šä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚ä¾èµ–äºä¸Šä¸€ä¸ªè¯·æ±‚çš„ç»“æœ

æˆ‘ä»¬ç”¨ setTimeout æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œï¼Œç”¨ Promise å’Œ Async/Await åˆ†åˆ«æ¥å®ç°ä¸‹

```js
function analogAsync(n) {
  return new Promise((resolve) => {
    setTimeout(() => resolve(n + 500), n)
  })
}

function fn1(n) {
  console.log(`step1 with ${n}`)
  return analogAsync(n)
}

function fn2(n) {
  console.log(`step2 with ${n}`)
  return analogAsync(n)
}

function fn3(n) {
  console.log(`step3 with ${n}`)
  return analogAsync(n)
}
```

ä½¿ç”¨ Promise

```js
function fn() {
  let time1 = 0
  fn1(time1)
    .then((time2) => fn2(time2))
    .then((time3) => fn3(time3))
    .then((res) => {
      console.log(`result is ${res}`)
    })
}

fn()
```

ä½¿ç”¨ Async/Await

```js
async function fn() {
  let time1 = 0
  let time2 = await fn1(time1)
  let time3 = await fn2(time2)
  let res = await fn3(time3)
  console.log(`result is ${res}`)
}

fn()
```

è¾“å‡ºç»“æœå’Œä¸Šé¢ç”¨ Promise å®ç°æ˜¯ä¸€æ ·çš„ï¼Œä½†è¿™ä¸ª `aaync/await` ä»£ç ç»“æ„çœ‹èµ·æ¥æ¸…æ™°å¾—å¤šï¼Œå‡ ä¹è·ŸåŒæ­¥å†™æ³•ä¸€æ ·ï¼Œååˆ†ä¼˜é›…

æˆ‘ä»¬å†æ¥çœ‹ä¸‹é¢è¿™ä¸ªå°ä¾‹å­

```js
// Generator
function* gen() {
  let f1 = yield ajax()
  let f2 = yield ajax()
}
gen()

// async/await
async function asyncAjax() {
  let f1 = await ajax()
  let f2 = await ajax()
}
asyncAjax()
```

è¿™ä¸¤å—ä»£ç çœ‹ç€æ˜¯ä¸æ˜¯å‡ ä¹ä¸€æ ·

ä¸Šé¢å‡½æ•°ä¸º Generator å‡½æ•°æ‰§è¡Œä¸¤ä¸ª ajaxï¼Œä¸‹é¢å‡½æ•°ä¸º async/await æ‰§è¡Œ

æ¯”è¾ƒå¯å‘ç°ï¼Œä¸¤ä¸ªå‡½æ•°å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œ`async` ä¸è¿‡æ˜¯æŠŠ Generator å‡½æ•°çš„ `*` å·æ¢æˆ `async`ï¼Œ`yield` æ¢æˆ `await`

é‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°åœ¨è°ƒç”¨æ—¶ï¼ŒGenerator å‡½æ•°éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `next` æ–¹æ³•æˆ–è€…ä½¿ç”¨ co å‡½æ•°åº“æ‰å¯æ‰§è¡Œï¼Œè€Œä¸‹é¢çš„`async` å‡½æ•°ç›´æ¥å°±æŒ‰é¡ºåºæ‰§è¡Œå®Œæˆäº†ï¼Œä½¿ç”¨éå¸¸æ–¹ä¾¿

å¼‚æ­¥ç¼–ç¨‹è¿½æ±‚çš„æ˜¯ï¼Œè®©å®ƒæ›´åƒåŒæ­¥ç¼–ç¨‹ï¼Œ `Async/Await` å®Œç¾è¯ é‡Šäº†è¿™ä¸€ç‚¹

åˆ°è¿™é‡Œæˆ‘ä»¬å…¶å®å°±ä¸éš¾çœ‹å‡º `Async/Await` å·²ç»å®Œè™äº† `Generator` å’Œ `Promise`

å¯¹æ¯”æ¥çœ‹æˆ‘ä»¬å‘ç°ï¼ŒAsync å‡½æ•°è‡ªå¸¦æ‰§è¡Œå™¨

### Async/Await ä¼˜/ç¼º

#### ä¼˜ç‚¹

å†…ç½®æ‰§è¡Œå™¨ï¼Œ Generator å‡½æ•°çš„æ‰§è¡Œå¿…é¡»é æ‰§è¡Œå™¨ï¼Œæ‰€ä»¥æ‰æœ‰äº† co å‡½æ•°åº“ï¼Œè€Œ `async` å‡½æ•°è‡ªå¸¦æ‰§è¡Œå™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`async` å‡½æ•°çš„æ‰§è¡Œï¼Œä¸æ™®é€šå‡½æ•°ä¸€æ¨¡ä¸€æ ·ï¼Œåªè¦ä¸€è¡Œ

æ›´å¥½çš„è¯­ä¹‰ï¼Œ`async` å’Œ `await`ï¼Œæ¯”èµ· `*` å’Œ `yield`ï¼Œè¯­ä¹‰æ›´æ¸…æ¥šäº†ï¼Œ`async` è¡¨ç¤ºå‡½æ•°é‡Œæœ‰å¼‚æ­¥æ“ä½œï¼Œ`await` è¡¨ç¤ºç´§è·Ÿåœ¨åé¢çš„è¡¨è¾¾å¼éœ€è¦ç­‰å¾…ç»“æœ

æ›´å¹¿çš„é€‚ç”¨æ€§ï¼Œco å‡½æ•°åº“çº¦å®šï¼Œ`yield` å‘½ä»¤åé¢åªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡ï¼Œè€Œ `async` å‡½æ•°çš„ `await` å‘½ä»¤åé¢ï¼Œå¯ä»¥è·Ÿ Promise å¯¹è±¡å’ŒåŸå§‹ç±»å‹çš„å€¼(æ•°å€¼ã€å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼ï¼Œä½†è¿™æ—¶ç­‰åŒäºåŒæ­¥æ“ä½œ)

#### ç¼ºç‚¹

æ»¥ç”¨ `await` å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸º `await` ä¼šé˜»å¡ä»£ç ï¼Œä¹Ÿè®¸ä¹‹åçš„å¼‚æ­¥ä»£ç å¹¶ä¸ä¾èµ–äºå‰è€…ï¼Œä½†ä»ç„¶éœ€è¦ç­‰å¾…å‰è€…å®Œæˆï¼Œå¯¼è‡´ä»£ç å¤±å»äº†å¹¶å‘æ€§

## å¼‚æ­¥è§£å†³æ–¹æ¡ˆå¯¹æ¯”

åˆ«çœ‹äº†ï¼Œæˆ‘æ²¡æœ‰æ€»ç»“å¯¹æ¯”

å…¶å®ç›¸å¯¹æ¥è¯´å·²ç»å†™çš„å¾ˆè¯¦ç»†äº†ï¼Œèƒ½è®²å‡ºæ¥çš„æ‰ç®—æ˜¯è‡ªå·±çš„ï¼Œå¤§å®¶å¯æ ¹æ®æ¯ç§æ–¹æ¡ˆåˆ—å‡ºçš„ä¼˜ç¼ºç‚¹åŠ ä¸Šè‡ªå·±çš„ç†è§£åšä¸ªå¯¹æ¯”æˆ–ç€è¯´æ€»ç»“ï¼Œæ¯•ç«Ÿä½ éƒ½çœ‹åˆ°è¿™äº†ï¼Œä¹Ÿä¸å¦„èŠ±è´¹è¿™ä¹ˆé•¿æ—¶é—´æ¥é˜…è¯»è¿™ä¸¤ä¸‡å­—çš„å¹²å¸–å­ï¼Œæ€»å½’è¦æœ‰äº›æ”¶è·çš„

## å†™åœ¨æœ€å

æ°´å¹³æœ‰é™ï¼Œæ¬¢è¿æŒ‡é”™

ç å­—ä¸æ˜“ï¼Œå¤§å®¶æœ‰æ”¶è·åˆ«å¿˜äº†ç‚¹ä¸ªèµé¼“åŠ±ä¸‹

æœç´¢ã€ä¸æ­£ç»çš„å‰ç«¯ã€‘æˆ–ç›´æ¥æ‰«ç å¯ä»¥å…³æ³¨å…¬ä¼—å·çœ‹åˆ°æ›´å¤šçš„ç²¾å½©æ–‡ç« ï¼Œä¹Ÿæœ‰ä¸€äº›ç¾¤å‹æä¾›çš„å­¦ä¹ è§†é¢‘ã€èµ„æºå¹²è´§ä»€ä¹ˆçš„å…è´¹æ‹¿

ä¹Ÿå¯ä»¥ç›´æ¥åŠ æˆ‘å¾®ä¿¡ï¼Œè¿›äº¤æµç¾¤å­¦ä¹ äº¤æµ

![](https://gitee.com/IsboyJC/PictureBed/raw/master/other/qqz.png)

> å‚è€ƒ
>
> 1. [Javascript å¼‚æ­¥ç¼–ç¨‹çš„ 4 ç§æ–¹æ³•-é˜®ä¸€å³°](<[http://www.ruanyifeng.com/blog/2012/12/asynchronous%EF%BC%BFjavascript.html](http://www.ruanyifeng.com/blog/2012/12/asynchronousï¼¿javascript.html)>)
> 2. [Promise-MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)
> 3. [iterable-å»–é›ªå³°](https://www.liaoxuefeng.com/wiki/1022910821149312/1023024358748480)
> 4. [What is Promise.try, and why does it matter?](http://cryto.net/~joepie91/blog/2016/05/11/what-is-promise-try-and-why-does-it-matter/)
> 5. [ä»€ä¹ˆæ˜¯ Promise.tryï¼Œä¸ºä»€ä¹ˆå®ƒè¿™ä¹ˆé‡è¦ï¼Ÿ-å‚è€ƒ 4 è¯‘](https://segmentfault.com/a/1190000018586947)
> 6. [Promise/A+è§„èŒƒ-è‹±åŸæ–‡](https://promisesaplus.com/)
> 7. [Promise/A+è§„èŒƒ-ä¸­æ–‡è¯‘](http://www.ituring.com.cn/article/66566)
> 8. [Generator å‡½æ•°çš„å«ä¹‰ä¸ç”¨æ³•-é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2015/04/generator.html)
> 9. [Thunk å‡½æ•°çš„å«ä¹‰å’Œç”¨æ³•-é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2015/05/thunk.html)
> 10. [co å‡½æ•°åº“çš„å«ä¹‰å’Œç”¨æ³•-é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2015/05/co.html)
